<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    header {
      background: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats-view {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
    }

    .controls label {
      font-weight: bold;
      color: #333;
    }

    .controls input,
    .controls select {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      min-width: 120px;
    }

    .controls button {
      background: #2c3e50;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    .controls button:hover {
      background: #34495e;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .stats-table th {
      background: #2c3e50;
      color: white;
      padding: 15px 12px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .stats-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    .stats-table tr:hover {
      background: #f5f5f5;
    }

    .stats-table tr:last-child td {
      border-bottom: none;
    }

    .attendance-icon {
      font-size: 1.4em;
      font-weight: bold;
    }

    .attendance-present {
      color: #4CAF50;
    }

    .attendance-absent {
      color: #f44336;
    }

    .attendance-unchecked {
      color: #FF9800;
    }

    .attendance-reason {
      color: #2196F3;
      font-weight: bold;
      font-size: 0.85em;
    }

    .violation-btn {
      background: #ff5252;
      color: white;
      border: none;
      padding: 6px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s;
    }

    .violation-btn:hover {
      background: #d32f2f;
      transform: scale(1.05);
    }

    .no-violation {
      color: #999;
      font-size: 0.9em;
    }

    .no-data {
      text-align: center;
      color: #666;
      font-size: 18px;
      padding: 60px 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .modal input,
    .modal textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
      font-family: inherit;
    }

    .modal button {
      padding: 12px 24px;
      margin: 10px 5px 0 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .modal .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .modal .btn-secondary {
      background: #f44336;
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .stats-view {
        padding: 20px;
      }

      .controls {
        flex-direction: column;
        gap: 15px;
      }

      .legend {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .stats-table {
        font-size: 0.9em;
      }

      .stats-table th,
      .stats-table td {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>면학실 출결 통계 (담임선생님) - 2학년</h1>
  <div style="margin-top: 10px;">
    <button onclick="openStudentSearch()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
      학생 검색
    </button>
  </div>
</header>

  <div class="container">
    <div class="stats-view">
      <div class="controls">
        <div>
          <label>날짜:</label>
          <input type="date" id="statsDate" />
        </div>

        <div>
          <label>반(HR):</label>
          <select id="hrSelect">
            <option value="">--선택--</option>
          </select>
        </div>

        <button onclick="loadAttendanceStats()">조회</button>
      </div>

      <div class="legend">
        <div class="legend-item">
          <span class="attendance-icon attendance-present">O</span>
          <span>출석</span>
        </div>
        <div class="legend-item">
          <span class="attendance-icon attendance-absent">X</span>
          <span>결석</span>
        </div>
        <div class="legend-item">
          <span class="attendance-icon attendance-unchecked">?</span>
          <span>미체크</span>
        </div>
        <div class="legend-item">
          <span class="attendance-icon attendance-absent">X</span><span style="font-size:0.7em;color:#f44336;margin-left:2px;">사유</span>
          <span>사전결석(방과후, 1인1기 등)</span>
        </div>
      </div>

      <div id="statsTable"></div>
    </div>
  </div>

  <!-- 피드백 모달 -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <h3 id="feedbackTitle">피드백</h3>

      <label>제목:
        <input type="text" id="feedbackSubject" placeholder="제목을 입력하세요" />
      </label>

      <br><br>

      <label>내용:
        <textarea id="feedbackContent" placeholder="내용을 입력하세요" style="height: 150px; resize: vertical;"></textarea>
      </label>

      <br><br>

      <button class="btn-primary" onclick="sendFeedback()">전송</button>
      <button class="btn-secondary" onclick="closeFeedbackModal()">취소</button>
    </div>
  </div>

<!-- 학생 검색 모달 -->
<div id="studentSearchModal" class="modal">
  <div class="modal-content">
    <h3>학생 검색</h3>

    <label>학생 이름:
      <input type="text" id="studentSearchInput" placeholder="이름을 입력하세요" style="width: 100%; margin-top: 5px;" />
    </label>

    <br><br>

    <button class="btn-primary" onclick="searchStudent()">검색</button>
    <button class="btn-secondary" onclick="closeStudentSearchModal()">닫기</button>

    <div id="searchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
  </div>
</div>

  <script>
    let currentFeedbackType = "";

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  // 기본 날짜 = 어제 (로컬 시간 기준)
  const today = new Date();
  today.setDate(today.getDate() - 1); // 어제로 설정

  // 로컬 시간대 기준으로 YYYY-MM-DD 형식 만들기
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const yesterdayString = `${year}-${month}-${day}`;

  document.getElementById("statsDate").value = yesterdayString;

  // HR 목록 생성
  const select = document.getElementById("hrSelect");
  for (let i = 1; i <= 12; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i + "반";
    select.appendChild(option);
  }
});

    function loadAttendanceStats() {
      const date = document.getElementById("statsDate").value;
      const hr = document.getElementById("hrSelect").value;

      if (!date || !hr) {
        alert("날짜와 반(HR)을 모두 선택해주세요.");
        return;
      }

      // 로딩 표시
      document.getElementById("statsTable").innerHTML = '<div class="no-data">데이터를 불러오는 중...</div>';

      google.script.run
        .withSuccessHandler(drawStatsTable)
        .withFailureHandler(e => {
          document.getElementById("statsTable").innerHTML = '<div class="no-data">불러오기 실패: ' + e.message + '</div>';
        })
        .getHrAttendanceStats(date, hr);
    }

    function drawStatsTable(data) {
      const container = document.getElementById("statsTable");

      if (!data || data.length === 0) {
        container.innerHTML = '<div class="no-data">해당 날짜와 반에 대한 데이터가 없습니다.</div>';
        return;
      }

      // 출결 상태 아이콘/텍스트 변환 (사유 포함)
      const getAttendanceDisplay = (status) => {
        switch(status) {
          case "출석":
            return '<span class="attendance-icon attendance-present">O</span>';
          case "결석":
            return '<span class="attendance-icon attendance-absent">X</span>';
          case "미체크":
            return '<span class="attendance-icon attendance-unchecked">?</span>';
          default:
            // O, X, 미체크가 아닌 경우 사유로 표시 (결석 아이콘 + 사유)
            return '<span class="attendance-icon attendance-absent" title="' + status + '">X</span><br><span style="font-size:0.7em;color:#f44336;">' + status + '</span>';
        }
      };

      let html = `
        <table class="stats-table">
          <thead>
            <tr>
              <th>학번</th>
              <th>이름</th>
              <th>현재 좌석</th>
              <th>ET</th>
              <th>EP1</th>
              <th>EP2</th>
              <th>특이사항</th>
            </tr>
          </thead>
          <tbody>`;

      data.forEach(row => {
        const hasViolation = row.violationNote && row.violationNote.trim() !== "";

        html += `
          <tr>
            <td style="font-weight: bold;">${row.studentId}</td>
            <td style="font-weight: bold;">${row.name}</td>
            <td style="color: #666;">${row.seat}</td>
            <td>${getAttendanceDisplay(row.et)}</td>
            <td>${getAttendanceDisplay(row.ep1)}</td>
            <td>${getAttendanceDisplay(row.ep2)}</td>
            <td>
              ${hasViolation
                ? `<button class="violation-btn" onclick="showViolationDetail('${row.studentId}', '${row.name}', \`${row.violationNote.replace(/'/g, "\\'").replace(/\n/g, '\\n')}\`)">확인</button>`
                : '<span class="no-violation">-</span>'}
            </td>
          </tr>`;
      });

      html += `
          </tbody>
        </table>`;

      container.innerHTML = html;
    }

    function showViolationDetail(studentId, name, note) {
      const formattedNote = note.replace(/\\n/g, '\n');
      alert(`[${name} (${studentId})] 특이사항\n\n${formattedNote}`);
    }

    // 피드백 관련 함수들
    function openModal(type) {
      currentFeedbackType = type;
      const title = type === "bug" ? "버그 보고" : "개선 건의";

      document.getElementById("feedbackTitle").innerText = title;
      document.getElementById("feedbackSubject").value = "";
      document.getElementById("feedbackContent").value = "";
      document.getElementById("feedbackModal").style.display = "block";
    }

    function closeFeedbackModal() {
      document.getElementById("feedbackModal").style.display = "none";
      currentFeedbackType = "";
    }

// 학생 검색 모달 열기
function openStudentSearch() {
  document.getElementById("studentSearchInput").value = "";
  document.getElementById("searchResults").innerHTML = "";
  document.getElementById("studentSearchModal").style.display = "block";
}

// 학생 검색 모달 닫기
function closeStudentSearchModal() {
  document.getElementById("studentSearchModal").style.display = "none";
}

// 학생 검색 실행
function searchStudent() {
  const searchName = document.getElementById("studentSearchInput").value.trim();

  if (!searchName) {
    alert("학생 이름을 입력해주세요.");
    return;
  }

  document.getElementById("searchResults").innerHTML = '<div class="no-data">검색 중...</div>';

  google.script.run
    .withSuccessHandler(results => {
      displaySearchResults(results);
    })
    .withFailureHandler(error => {
      alert("검색 실패: " + error.message);
    })
    .searchStudentByName(searchName);
}

// 검색 결과 표시
function displaySearchResults(results) {
  const container = document.getElementById("searchResults");

  if (!results || results.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">검색 결과가 없습니다.</p>';
    return;
  }

  let html = '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px;">';

  results.forEach((student, index) => {
    const isDevRoom = student.movedSeat && student.moveDate;
    const currentDate = new Date().toISOString().slice(0, 10);
    const isMoved = isDevRoom && currentDate >= student.moveDate;

    html += `
      <div style="padding: 10px; ${index > 0 ? 'border-top: 1px solid #eee;' : ''} background: ${isMoved ? '#ffebee' : '#f5f5f5'}; margin-bottom: 5px; border-radius: 4px;">
        <strong style="color: #2c3e50;">${student.name}</strong><br>
        <span style="color: #666;">학번: ${student.studentId}</span><br>
        <span style="color: #666;">HR: ${student.hr || '-'}반</span><br>
        ${isMoved ?
          `<span style="color: #d32f2f; font-weight: bold;">발전실: ${student.movedSeat}</span><br>
           <span style="color: #d32f2f;">이동일: ${student.moveDate}</span>` :
          `<span style="color: #388e3c;">좌석: ${student.seat}</span><br>
           <span style="color: #388e3c;">교실: ${student.classroom}</span>`
        }
      </div>
    `;
  });

  html += '</div>';
  container.innerHTML = html;
}

// 엔터키로 검색 실행
document.getElementById('studentSearchInput').addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    searchStudent();
  }
});

    function sendFeedback() {
      const subject = document.getElementById("feedbackSubject").value.trim();
      const content = document.getElementById("feedbackContent").value.trim();

      if (!subject) {
        alert("제목을 입력해주세요.");
        return;
      }

      if (!content) {
        alert("내용을 입력해주세요.");
        return;
      }

      const typeKorean = currentFeedbackType === "bug" ? "버그 보고" : "개선 건의";

      google.script.run
        .withSuccessHandler(result => {
          alert(`${result}`);
          closeFeedbackModal();
        })
        .withFailureHandler(error => {
          alert(`전송 실패: ${error.message}`);
        })
        .sendFeedbackEmail(typeKorean, subject, content);
    }

 // ESC 키로 모달 닫기
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    if (document.getElementById('feedbackModal').style.display === 'block') {
      closeFeedbackModal();
    }
    if (document.getElementById('studentSearchModal').style.display === 'block') {
      closeStudentSearchModal();
    }
  }
});

// 모달 배경 클릭으로 닫기
document.getElementById('feedbackModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeFeedbackModal();
  }
});

document.getElementById('studentSearchModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeStudentSearchModal();
  }
});
  </script>
</body>
</html>
