<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <?!= include('styles'); ?>
</head>
<body>
  <header>
    <div>면학실 관리 어플</div>
    <div class="quick-classroom-buttons" style="display: flex; flex-wrap: wrap; gap: 4px; margin-left: 1em;">
      <button onclick="openClassroom('3A')">3A</button>
      <button onclick="openClassroom('3B')">3B</button>
      <button onclick="openClassroom('3C')">3C</button>
      <button onclick="openClassroom('3D')">3D</button>
      <button onclick="openClassroom('C306')">C306</button>
      <button onclick="openClassroom('C307')">C307</button>
      <button onclick="openClassroom('C309')">C309</button>
    </div>
    <div class="menu">
      <button onclick="goHome()">홈</button>
      <button onclick="openStudentSearch()">학생 검색</button>
      <button onclick="showGuideDirectly()">안내사항</button>
      <button onclick="showTutorial()">튜토리얼</button>
      <button onclick="openGeneralFeedback()">기타 특이사항</button>
      <button onclick="openModal('bug')">버그 보고</button>
      <button onclick="openModal('idea')">개선 건의</button>

      <span id="headerAttendanceButtons" style="display: none;">
        <button onclick="markAllSeats('출석')" style="background:#4CAF50; color:white; font-weight:bold;">일괄출석</button>
        <button onclick="markAllSeats('결석')" style="background:#9e9e9e; color:white; font-weight:bold;">일괄결석</button>
        <button onclick="tempSaveAttendance()" style="background:#ff9800; color:white; font-weight:bold;">임시저장</button>
        <button onclick="saveAttendanceForClassroom()" style="background:#2c3e50; color:white; font-weight:bold;">출결저장</button>
      </span>
    </div>
  </header>

  <!-- 홈 화면 -->
  <div id="homeScreen" style="display: none;">
    <div class="floor-plan-container">
      <div class="floor-plan">
        <div class="corridor corridor-central"></div>
        <div class="corridor corridor-top"></div>
        <div class="main-entrance"></div>
        <div class="classroom-area classroom-3a" onclick="openClassroom('3A')">3A</div>
        <div class="classroom-area classroom-3b" onclick="openClassroom('3B')">3B</div>
        <div class="classroom-area classroom-3c" onclick="openClassroom('3C')">3C</div>
        <div class="classroom-area classroom-3d" onclick="openClassroom('3D')">3D</div>
      </div>
    </div>

    <div class="other-classrooms">
      <button class="other-classroom-btn" onclick="openClassroom('C306')">C306</button>
      <button class="other-classroom-btn" onclick="openClassroom('C307')">C307</button>
      <button class="other-classroom-btn" onclick="openClassroom('C309')">C309</button>
    </div>
  </div>

  <!-- 출결 통계 화면 -->
  <div id="statsView" style="display:none; padding:1em;">
    <h2 style="color: #2c3e50;">출결 통계</h2>
    <label>날짜: <input type="date" id="statsDate" /></label>
    <label>반(HR): <select id="hrSelect"></select></label>
    <button onclick="loadAttendanceStats()" style="background: #2c3e50; color: white;">조회</button>
    <div id="statsTable" style="margin-top: 1em;"></div>
  </div>

  <!-- 교실 뷰 -->
  <div class="container" id="classroomView" style="display:none;">
    <h2 id="classroomTitle" style="color: #2c3e50;"></h2>
    <div id="timeSlotButtons" style="margin-bottom: 1em;">
      <button class="time-btn active" data-slot="ET" onclick="selectTimeSlot('ET')">ET</button>
      <button class="time-btn" data-slot="EP1" onclick="selectTimeSlot('EP1')">EP1</button>
      <button class="time-btn" data-slot="EP2" onclick="selectTimeSlot('EP2')">EP2</button>
    </div>
    <div id="seatGrid"></div>
  </div>

  <!-- 학생 정보 모달 -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <h3>학생 정보</h3>
      <p id="studentInfoText">불러오는 중...</p>

      <div style="margin: 15px 0; text-align: center;">
        <button id="sleepPostItBtn" onclick="toggleSleepPostIt()"
          style="background: #ffc107; color: #333; padding: 10px 20px;
          font-size: 1em; border-radius: 8px; font-weight: bold;">
          수면 포스트잇 사용
        </button>
      </div>

      <h4>위반 사항 및 적발상황 기록</h4>

      <label id="violationTypeLabel">위반 유형:
        <select id="violationType">
          <option value="">--선택하기--</option>
          <option value="수면">수면</option>
          <option value="전자기기">전자기기 사용</option>
          <option value="이석">이석</option>
          <option value="기타">기타</option>
        </select>
      </label>

      <br><br>
      <label>적발상황:
        <textarea id="violationNote"
          placeholder="적발 당시 상황(포스트잇 없이 엎드려잠, 게임 등)을 적어주세요"
          style="width: 100%; height: 80px; margin-top: 5px; resize: vertical;">
        </textarea>
      </label>

      <br>

      <!-- 오늘 위반사항 섹션 -->
      <div id="todayViolations" style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 8px; display: none;">
        <h4 style="color: #856404; margin-bottom: 10px;">오늘 기록된 위반사항</h4>
        <div id="violationsList"></div>
      </div>

      <div class="modal-buttons">
        <button onclick="saveViolation()">저장</button>
        <button onclick="closeModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 피드백 모달 -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <h3 id="feedbackTitle">피드백</h3>

      <label>제목:
        <input type="text" id="feedbackSubject" placeholder="제목을 입력하세요" style="width: 100%; margin-top: 5px;" />
      </label>

      <br><br>

      <label>내용:
        <textarea id="feedbackContent" placeholder="내용을 입력하세요" style="width: 100%; height: 150px; margin-top: 5px; resize: vertical;"></textarea>
      </label>

      <br><br>

      <button onclick="sendFeedback()" style="background: #4CAF50; color: white;">전송</button>
      <button onclick="closeFeedbackModal()" style="background: #f44336; color: white;">취소</button>
    </div>
  </div>

  <!-- 학생 검색 모달 -->
  <div id="studentSearchModal" class="modal">
    <div class="modal-content">
      <h3>학생 검색</h3>

      <label>학생 이름:
        <input type="text" id="studentSearchInput" placeholder="이름을 입력하세요" style="width: 100%; margin-top: 5px;" />
      </label>

      <br><br>

      <button onclick="searchStudent()" style="background: #2196F3; color: white;">검색</button>
      <button onclick="closeStudentSearchModal()" style="background: #f44336; color: white;">닫기</button>

      <div id="searchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- 면학 감독 안내 화면 -->
  <div id="guideView" style="display: none; padding: 20px; background: white; min-height: 100vh;">
    <div style="max-width: 800px; margin: 0 auto;">
      <h1 style="text-align: center; color: #2c3e50; margin-bottom: 10px;">2학년 면학 감독 안내</h1>
      <p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1em;">위반 사항 처리 중심</p>

      <div style="background: #f5f5f5; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #d32f2f; margin-bottom: 20px; font-size: 1.5em;">위반 사항 기준 및 처리</h2>

        <div style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px;">
          <h3 style="color: #1976d2; margin-bottom: 15px;">수면 (완전히 엎드려 잠)</h3>
          <ul style="line-height: 2; font-size: 1.05em;">
            <li><strong>포스트잇 없을 경우</strong>: 즉시 체크 후 학생에게 고지</li>
            <li><strong>포스트잇 있을 경우</strong>:
              <ul style="margin-top: 10px;">
                <li>수면 시작 시간 기준 <strong style="color: #d32f2f; font-size: 1.1em;">15분 이내</strong> 허용</li>
                <li><strong>포스트잇이 떨어졌는지</strong>, <strong>태블릿 화면이 꺼졌는지</strong> 확인</li>
                <li><strong style="color: #d32f2f; font-size: 1.1em;">1일 1회만 사용 가능</strong>, 두 번째부터 무효</li>
              </ul>
            </li>
            <li>허용 시간 초과 시 체크</li>
          </ul>
        </div>

        <div style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px;">
          <h3 style="color: #1976d2; margin-bottom: 15px;">졸음 (애매하게 조는 경우)</h3>
          <ul style="line-height: 2; font-size: 1.05em;">
            <li>무조건 깨운다</li>
            <li>"잤어, 졸았어?" 질문</li>
            <li><strong>인정 시 체크</strong>, 포스트잇 사용 가능</li>
            <li><strong style="color: #d32f2f; font-size: 1.1em;">재적발 시 체크 처리</strong></li>
          </ul>
        </div>

        <div style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px;">
          <h3 style="color: #1976d2; margin-bottom: 15px;">전자기기 (게임, 웹툰, 릴스 등)</h3>
          <ul style="line-height: 2; font-size: 1.05em;">
            <li><strong style="color: #d32f2f; font-size: 1.1em;">5초 이상 사용 여부</strong> 확인 후 체크</li>
            <li>쉬는시간 실수 등의 해명 발생 시 → <strong>현장에서 즉시 확인 및 처리</strong></li>
          </ul>
        </div>

        <div style="margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px;">
          <h3 style="color: #1976d2; margin-bottom: 15px;">이석 (면학실 출입문 밖으로 이동)</h3>
          <ul style="line-height: 2; font-size: 1.05em;">
            <li>화장실, 라커 사용 시 이석 체크</li>
            <li><strong style="color: #388e3c; font-size: 1.1em;">면학실 내부 복도 이동, 스탠딩 책상 이용은 이석 아님</strong></li>
          </ul>
        </div>
      </div>

      <div style="background: #fff3cd; padding: 25px; border-radius: 12px; border: 2px solid #ffeaa7; margin-bottom: 30px;">
        <h2 style="color: #856404; margin-bottom: 20px; font-size: 1.5em;">체크 시 주의사항</h2>
        <ul style="line-height: 2; font-size: 1.1em;">
          <li>위반 사항 체크 시 <strong style="font-size: 1.1em;">해당 학생에게 즉시 고지</strong></li>
          <li><strong>체크한 상황을 특이사항란에 구체적으로 함께 메모해주세요</strong><br>
            <span style="color: #666; font-size: 0.95em; display: block; margin-top: 5px; padding-left: 20px;">
              예: "포스트잇 없음", "전자기기 동영상 10초 이상 시청", "졸음 인정함" 등
            </span>
          </li>
          <li>기록은 다음날 소명 및 관리에 <strong style="color: #d32f2f; font-size: 1.1em;">중요한 근거</strong>가 됩니다</li>
        </ul>
      </div>

      <!-- 수면 포스트잇 관리 섹션 -->
      <div style="background: #fffde7; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #f57f17;">수면 포스트잇 관리</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <h3>수면 포스트잇 사용 방법</h3>
          <ol style="line-height: 1.8;">
            <li>수면 포스트잇을 사용하는 학생의 좌석을 <strong>길게 누릅니다</strong></li>
            <li><strong style="color: #f57f17;">수면 포스트잇 사용</strong> 버튼을 누릅니다</li>
            <li>해당 학생의 좌석에 <strong style="color: #ff5252;">빨간색 테두리</strong>가 표시됩니다</li>
            <li>시작 시간이 자동으로 기록됩니다</li>
          </ol>

          <h3 style="margin-top: 20px;">수면 포스트잇 취소 방법</h3>
          <ol style="line-height: 1.8;">
            <li>수면 포스트잇을 사용 중인 학생의 좌석을 <strong>길게 누릅니다</strong></li>
            <li><strong style="color: #ff6b6b;">수면 포스트잇 취소</strong> 버튼을 누릅니다</li>
            <li>확인 메시지가 나타나면 '확인'을 누릅니다</li>
            <li>빨간색 테두리가 사라집니다</li>
          </ol>

          <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h4 style="color: #e65100; margin-bottom: 10px;">주의사항</h4>
            <ul style="line-height: 1.6;">
              <li><strong>1일 1회만 사용 가능</strong> - 한 번 사용한 학생은 당일 재사용 불가</li>
              <li>사용 중인 학생은 버튼이 <strong style="color: #ff6b6b;">'취소'</strong>로 변경됩니다</li>
              <li>실수로 등록한 경우 언제든지 취소 가능합니다</li>
              <li>다음 날 자동으로 초기화됩니다</li>
              <li><strong style="color: #d32f2f;">15분 초과 시 수면 위반으로 체크</strong>해야 합니다</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 안내사항 페이지의 체크박스 -->
      <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #a5d6a7;">
        <label style="display: flex; align-items: center; font-weight: bold; cursor: pointer; font-size: 1.2em;">
          <input type="checkbox" id="guideConfirm" style="margin-right: 15px; width: 24px; height: 24px;">
          위 내용을 모두 읽고 이해했습니다
        </label>
      </div>

      <div style="text-align: center;">
        <button id="guideCloseBtn" onclick="closeGuideView()"
          style="background: #ccc; color: white; padding: 15px 50px; font-size: 1.2em;
          cursor: not-allowed; border-radius: 8px; font-weight: bold;" disabled>
          확인하고 시작하기
        </button>
      </div>

      <div style="background: #e1f5fe; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #81d4fa;">
        <p style="text-align: center; font-size: 1.1em; margin: 0;">
          <strong>처음 사용하시나요?</strong><br>
          상단 메뉴의 <strong style="color: #0288d1;">튜토리얼</strong> 버튼을 눌러 자세한 사용법을 확인하세요!
        </p>
      </div>
    </div>
  </div>

  <!-- 튜토리얼 화면 -->
  <div id="tutorialView" style="display: none; padding: 20px; background: white; min-height: 100vh;">
    <div style="max-width: 800px; margin: 0 auto;">
      <button onclick="closeTutorial()" style="float: right; background: #f44336; color: white; padding: 10px 20px; border-radius: 5px;">닫기</button>

      <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">면학실 관리 앱 사용법</h1>

      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #1976d2;">기본 사용법</h2>

        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
          <h3>1. 교실 선택</h3>
          <ul style="line-height: 1.8;">
            <li><strong>홈 화면 도면</strong>에서 해당 교실 영역을 터치합니다</li>
            <li>3A, 3B, 3C, 3D는 실제 위치대로 배치되어 있습니다</li>
            <li>C306, C307, C309는 하단 버튼으로 접근합니다</li>
            <li>상단 빠른 접근 버튼으로도 교실 이동이 가능합니다</li>
          </ul>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
          <h3>2. 시간대 선택</h3>
          <ul style="line-height: 1.8;">
            <li><strong>ET</strong>: 저녁 자습 시간 (16:50 ~ 18:10)</li>
            <li><strong>EP1</strong>: 저녁 프로그램 1교시 (19:20 ~ 20:50)</li>
            <li><strong>EP2</strong>: 저녁 프로그램 2교시 (21:10 ~ 22:30)</li>
            <li>현재 시간에 맞는 시간대가 <strong style="color: #4CAF50;">자동으로 선택됩니다</strong></li>
          </ul>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
          <h3>3. 출결 체크</h3>
          <ul style="line-height: 1.8;">
            <li><strong>터치/클릭</strong>: 미체크 → 출석 → 결석 순환</li>
            <li><strong style="color: #fff3cd;">노란색</strong>: 미체크</li>
            <li><strong style="color: #4CAF50;">파란색</strong>: 출석</li>
            <li><strong style="color: #666;">회색</strong>: 결석</li>
            <li><strong style="color: #ff9999;">빨간색</strong>: 발전실 이동</li>
            <li><strong style="color: #ff5252;">빨간 테두리</strong>: 수면 포스트잇 사용 중</li>
          </ul>
        </div>
      </div>

      <div style="background: #fff3cd; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #856404;">위반사항 기록</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <h3>길게 누르기 (0.8초)</h3>
          <ol style="line-height: 1.8;">
            <li>해당 학생 좌석을 <strong>길게 누릅니다</strong></li>
            <li>학생 정보 확인 후 위반 유형을 선택합니다
              <ul style="margin-top: 5px;">
                <li>수면</li>
                <li>전자기기 사용</li>
                <li>이석</li>
                <li>특이사항 입력</li>
              </ul>
            </li>
            <li>상세 메모에 구체적인 상황을 기록합니다</li>
            <li>저장 버튼을 눌러 기록을 완료합니다</li>
          </ol>
          <p style="color: #d32f2f; margin-top: 10px;">
            <strong>중요</strong>: 위반사항은 반드시 해당 학생에게 고지하세요
          </p>
        </div>
      </div>

      <div style="background: #fffde7; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #f57f17;">수면 포스트잇 관리</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <h3>사용 방법</h3>
          <ol style="line-height: 1.8;">
            <li>수면 포스트잇을 사용하는 학생의 좌석을 <strong>길게 누릅니다</strong></li>
            <li><strong style="color: #f57f17;">수면 포스트잇 사용</strong> 버튼을 누릅니다</li>
            <li>해당 학생의 좌석에 <strong style="color: #ff5252;">빨간색 테두리</strong>가 표시됩니다</li>
            <li>시작 시간이 자동으로 기록됩니다</li>
          </ol>

          <h3 style="margin-top: 20px;">취소 방법</h3>
          <ul style="line-height: 1.8;">
            <li>사용 중인 학생의 좌석을 길게 누른 후</li>
            <li><strong style="color: #ff6b6b;">수면 포스트잇 취소</strong> 버튼을 누릅니다</li>
          </ul>

          <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h4 style="color: #e65100; margin-bottom: 10px;">주의사항</h4>
            <ul style="line-height: 1.6;">
              <li><strong>1일 1회만 사용 가능</strong></li>
              <li><strong style="color: #d32f2f;">15분 초과 시 수면 위반으로 체크</strong>해야 합니다</li>
              <li>다음 날 자동으로 초기화됩니다</li>
            </ul>
          </div>
        </div>
      </div>

      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #0277bd;">기타 특이사항</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <h3>언제 사용하나요?</h3>
          <ul style="line-height: 1.8;">
            <li><strong>학교 행사</strong>로 학생들이 단체로 불참할 때</li>
            <li><strong>학급 행사</strong>로 특정 반이 단체로 빠질 때</li>
            <li><strong>대회 참가</strong>로 여러 학생이 불참할 때</li>
            <li>면학실 운영 관련 특이사항이 있을 때</li>
          </ul>

          <h3 style="margin-top: 20px;">사용 방법</h3>
          <ol style="line-height: 1.8;">
            <li>상단 메뉴의 <strong>기타 특이사항</strong> 버튼을 클릭</li>
            <li>제목에 간단한 요약 입력 (예: "2-3반 학급행사")</li>
            <li>내용에 상세 내용 입력 (날짜, 시간, 참여 학생 등)</li>
            <li>전송 버튼 클릭</li>
          </ol>
        </div>
      </div>

      <div style="background: #fce4ec; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #880e4f;">위반사항 취소</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <p style="margin-bottom: 15px;">실수로 위반사항을 체크한 경우:</p>
          <ol style="line-height: 1.8;">
            <li>해당 학생 좌석을 <strong>길게 누릅니다</strong></li>
            <li>오늘 기록된 위반사항이 표시됩니다</li>
            <li>삭제하려는 항목의 <strong style="color: #dc3545;">삭제</strong> 버튼을 누릅니다</li>
            <li>확인 메시지가 나타나면 '확인'을 누릅니다</li>
          </ol>
          <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
            ※ 오늘 기록된 위반사항만 삭제 가능합니다
          </p>
        </div>
      </div>

      <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <h2 style="color: #388e3c;">출결 저장</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <ul style="line-height: 1.8;">
            <li>모든 학생의 출결 체크 완료 후 <strong>출결 저장</strong> 버튼을 누릅니다</li>
            <li>미체크 학생이 있으면 저장되지 않습니다</li>
            <li>저장 중에는 버튼이 비활성화됩니다</li>
            <li>저장 소요 시간: <strong>약 3초</strong></li>
            <li>이미 저장된 시간대는 덮어쓰기 확인 메시지가 나타납니다</li>
          </ul>
        </div>
      </div>

      <div style="background: #e1f5fe; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #81d4fa;">
        <h2 style="color: #0288d1;">유용한 팁</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <ul style="line-height: 1.8;">
            <li><strong>빠른 교실 이동</strong>: 상단의 교실 버튼 사용</li>
            <li><strong>일괄 처리</strong>: 일괄 출석, 일괄 결석 버튼 활용</li>
            <li><strong>실수 방지</strong>: 저장 전 미체크 학생 확인</li>
            <li><strong>모바일 최적화</strong>: 태블릿과 스마트폰 모두 지원</li>
            <li><strong>네트워크 오류 시</strong>: Wi-Fi 연결 확인 후 새로고침</li>
          </ul>
        </div>
      </div>

      <div style="background: #ffebee; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #ef9a9a;">
        <h2 style="color: #c62828;">자주 발생하는 문제</h2>

        <div style="background: white; padding: 20px; border-radius: 8px;">
          <ul style="line-height: 1.8;">
            <li><strong>저장이 안 됨</strong>: 미체크(노란색) 학생이 있는지 확인</li>
            <li><strong>ET 탭이 자동 선택됨</strong>: 브라우저 새로고침 후 다시 시도</li>
            <li><strong>길게 누르기 안 됨</strong>: 0.8초 이상 꾹 누르세요</li>
            <li><strong>수면 포스트잇 버튼 비활성화</strong>: 이미 사용한 학생입니다</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <?!= include('scripts'); ?>
</body>
</html>
