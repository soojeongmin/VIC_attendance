<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f5f5f5;
    }
    
    header {
      background: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats-view {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
    }

    .controls label {
      font-weight: bold;
      color: #333;
    }

    .controls input,
    .controls select {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      min-width: 120px;
    }

    .controls button {
      background: #2c3e50;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    .controls button:hover {
      background: #34495e;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .stats-table th {
      background: #2c3e50;
      color: white;
      padding: 15px 12px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .stats-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    .stats-table tr:hover {
      background: #f5f5f5;
    }

    .stats-table tr:last-child td {
      border-bottom: none;
    }

    .attendance-icon {
      font-size: 1.4em;
      font-weight: bold;
    }

    .attendance-present {
      color: #4CAF50;
    }

    .attendance-absent {
      color: #f44336;
    }

    .attendance-unchecked {
      color: #FF9800;
    }

    .violation-btn {
      background: #ff5252;
      color: white;
      border: none;
      padding: 6px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s;
    }

    .violation-btn:hover {
      background: #d32f2f;
      transform: scale(1.05);
    }

    .no-violation {
      color: #999;
      font-size: 0.9em;
    }

    .no-data {
      text-align: center;
      color: #666;
      font-size: 18px;
      padding: 60px 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .modal input,
    .modal textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
      font-family: inherit;
    }

    .modal button {
      padding: 12px 24px;
      margin: 10px 5px 0 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .modal .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .modal .btn-secondary {
      background: #f44336;
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .stats-view {
        padding: 20px;
      }
      
      .controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .legend {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .stats-table {
        font-size: 0.9em;
      }
      
      .stats-table th,
      .stats-table td {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>ğŸ« ë©´í•™ì‹¤ ì¶œê²° í†µê³„ (ë‹´ì„ì„ ìƒë‹˜)</h1>
  <div style="margin-top: 10px;">
    <button onclick="openStudentSearch()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
      ğŸ” í•™ìƒ ê²€ìƒ‰
    </button>
  </div>
</header>

  <div class="container">
    <div class="stats-view">
      <div class="controls">
        <div>
          <label>ë‚ ì§œ:</label>
          <input type="date" id="statsDate" />
        </div>
        
        <div>
          <label>ë°˜(HR):</label>
          <select id="hrSelect">
            <option value="">--ì„ íƒ--</option>
          </select>
        </div>
        
        <button onclick="loadAttendanceStats()">ğŸ“Š ì¡°íšŒ</button>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <span class="attendance-icon attendance-present">â˜‘</span>
          <span>ì¶œì„</span>
        </div>
        <div class="legend-item">
          <span class="attendance-icon attendance-absent">â˜</span>
          <span>ê²°ì„</span>
        </div>
        <div class="legend-item">
          <span class="attendance-icon attendance-unchecked">?</span>
          <span>ë¯¸ì²´í¬</span>
        </div>
        <div class="legend-item">
          <span class="attendance-icon attendance-absent">â˜</span><span style="font-size:0.7em;color:#f44336;margin-left:2px;">ì‚¬ìœ </span>
          <span>ì‚¬ì „ê²°ì„(ë°©ê³¼í›„, 1ì¸1ê¸° ë“±)</span>
        </div>
      </div>
      
      <div id="statsTable"></div>
    </div>
  </div>

  <!-- í”¼ë“œë°± ëª¨ë‹¬ -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <h3 id="feedbackTitle">í”¼ë“œë°±</h3>
      
      <label>ì œëª©:
        <input type="text" id="feedbackSubject" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
      </label>
      
      <br><br>
      
      <label>ë‚´ìš©:
        <textarea id="feedbackContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="height: 150px; resize: vertical;"></textarea>
      </label>
      
      <br><br>
      
      <button class="btn-primary" onclick="sendFeedback()">ì „ì†¡</button>
      <button class="btn-secondary" onclick="closeFeedbackModal()">ì·¨ì†Œ</button>
    </div>
  </div>
<!-- í•™ìƒ ê²€ìƒ‰ ëª¨ë‹¬ -->
<div id="studentSearchModal" class="modal">
  <div class="modal-content">
    <h3>ğŸ” í•™ìƒ ê²€ìƒ‰</h3>
    
    <label>í•™ìƒ ì´ë¦„:
      <input type="text" id="studentSearchInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; margin-top: 5px;" />
    </label>
    
    <br><br>
    
    <button class="btn-primary" onclick="searchStudent()">ê²€ìƒ‰</button>
    <button class="btn-secondary" onclick="closeStudentSearchModal()">ë‹«ê¸°</button>
    
    <div id="searchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
  </div>
</div>
  <script>
    let currentFeedbackType = "";

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  // ê¸°ë³¸ ë‚ ì§œ = ì–´ì œ (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€)
  const today = new Date();
  today.setDate(today.getDate() - 1); // ì–´ì œë¡œ ì„¤ì •
  
  // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD í˜•ì‹ ë§Œë“¤ê¸°
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const yesterdayString = `${year}-${month}-${day}`;
  
  document.getElementById("statsDate").value = yesterdayString;

  // HR ëª©ë¡ ìƒì„±
  const select = document.getElementById("hrSelect");
  for (let i = 1; i <= 12; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i + "ë°˜";
    select.appendChild(option);
  }
});
    function loadAttendanceStats() {
      const date = document.getElementById("statsDate").value;
      const hr = document.getElementById("hrSelect").value;

      if (!date || !hr) {
        alert("ë‚ ì§œì™€ ë°˜(HR)ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      // ë¡œë”© í‘œì‹œ
      document.getElementById("statsTable").innerHTML = '<div class="no-data">ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      google.script.run
        .withSuccessHandler(drawStatsTable)
        .withFailureHandler(e => {
          document.getElementById("statsTable").innerHTML = '<div class="no-data">âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message + '</div>';
        })
        .getHrAttendanceStats(date, hr);
    }

    function drawStatsTable(data) {
      const container = document.getElementById("statsTable");
      
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="no-data">ğŸ“­ í•´ë‹¹ ë‚ ì§œì™€ ë°˜ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const getAttendanceIcon = (status) => {
        switch(status) {
          case "ì¶œì„":
            return '<span class="attendance-icon attendance-present">â˜‘</span>';
          case "ê²°ì„":
            return '<span class="attendance-icon attendance-absent">â˜</span>';
          case "ë¯¸ì²´í¬":
            return '<span class="attendance-icon attendance-unchecked">?</span>';
          default:
            // ì¶œì„, ê²°ì„, ë¯¸ì²´í¬ê°€ ì•„ë‹Œ ê²½ìš° ì‚¬ìœ  í‘œì‹œ (ë°©ê³¼í›„, 1ì¸1ê¸° ë“±)
            return '<span class="attendance-icon attendance-absent" title="' + status + '">â˜</span><br><span style="font-size:0.7em;color:#f44336;">' + status + '</span>';
        }
      };

      let html = `
        <table class="stats-table">
          <thead>
            <tr>
              <th>í•™ë²ˆ</th>
              <th>ì´ë¦„</th>
              <th>í˜„ì¬ ì¢Œì„</th>
              <th>ET</th>
              <th>EP1</th>
              <th>EP2</th>
              <th>íŠ¹ì´ì‚¬í•­</th>
            </tr>
          </thead>
          <tbody>`;

      data.forEach(row => {
        const hasViolation = row.violationNote && row.violationNote.trim() !== "";
        
        html += `
          <tr>
            <td style="font-weight: bold;">${row.studentId}</td>
            <td style="font-weight: bold;">${row.name}</td>
            <td style="color: #666;">${row.seat}</td>
            <td>${getAttendanceIcon(row.et)}</td>
            <td>${getAttendanceIcon(row.ep1)}</td>
            <td>${getAttendanceIcon(row.ep2)}</td>
            <td>
              ${hasViolation
                ? `<button class="violation-btn" onclick="showViolationDetail('${row.studentId}', '${row.name}', \`${row.violationNote.replace(/'/g, "\\'").replace(/\n/g, '\\n')}\`)">í™•ì¸</button>`
                : '<span class="no-violation">-</span>'}
            </td>
          </tr>`;
      });

      html += `
          </tbody>
        </table>`;
      
      container.innerHTML = html;
    }

    function showViolationDetail(studentId, name, note) {
      const formattedNote = note.replace(/\\n/g, '\n');
      alert(`[${name} (${studentId})] íŠ¹ì´ì‚¬í•­\n\n${formattedNote}`);
    }

    // í”¼ë“œë°± ê´€ë ¨ í•¨ìˆ˜ë“¤
    function openModal(type) {
      currentFeedbackType = type;
      const title = type === "bug" ? "ğŸ ë²„ê·¸ ë³´ê³ " : "ğŸ’¡ ê°œì„  ê±´ì˜";
      
      document.getElementById("feedbackTitle").innerText = title;
      document.getElementById("feedbackSubject").value = "";
      document.getElementById("feedbackContent").value = "";
      document.getElementById("feedbackModal").style.display = "block";
    }

    function closeFeedbackModal() {
      document.getElementById("feedbackModal").style.display = "none";
      currentFeedbackType = "";
    }
// í•™ìƒ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
function openStudentSearch() {
  document.getElementById("studentSearchInput").value = "";
  document.getElementById("searchResults").innerHTML = "";
  document.getElementById("studentSearchModal").style.display = "block";
}

// í•™ìƒ ê²€ìƒ‰ ëª¨ë‹¬ ë‹«ê¸°
function closeStudentSearchModal() {
  document.getElementById("studentSearchModal").style.display = "none";
}

// í•™ìƒ ê²€ìƒ‰ ì‹¤í–‰
function searchStudent() {
  const searchName = document.getElementById("studentSearchInput").value.trim();
  
  if (!searchName) {
    alert("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  document.getElementById("searchResults").innerHTML = '<div class="no-data">ê²€ìƒ‰ ì¤‘...</div>';
  
  google.script.run
    .withSuccessHandler(results => {
      displaySearchResults(results);
    })
    .withFailureHandler(error => {
      alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + error.message);
    })
    .searchStudentByName(searchName);
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function displaySearchResults(results) {
  const container = document.getElementById("searchResults");
  
  if (!results || results.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  let html = '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px;">';
  
  results.forEach((student, index) => {
    const isDevRoom = student.movedSeat && student.moveDate;
    const currentDate = new Date().toISOString().slice(0, 10);
    const isMoved = isDevRoom && currentDate >= student.moveDate;
    
    html += `
      <div style="padding: 10px; ${index > 0 ? 'border-top: 1px solid #eee;' : ''} background: ${isMoved ? '#ffebee' : '#f5f5f5'}; margin-bottom: 5px; border-radius: 4px;">
        <strong style="color: #2c3e50;">${student.name}</strong><br>
        <span style="color: #666;">í•™ë²ˆ: ${student.studentId}</span><br>
        <span style="color: #666;">HR: ${student.hr || '-'}ë°˜</span><br>
        ${isMoved ? 
          `<span style="color: #d32f2f; font-weight: bold;">ğŸ“ ë°œì „ì‹¤: ${student.movedSeat}</span><br>
           <span style="color: #d32f2f;">ì´ë™ì¼: ${student.moveDate}</span>` :
          `<span style="color: #388e3c;">ğŸ“ ì¢Œì„: ${student.seat}</span><br>
           <span style="color: #388e3c;">êµì‹¤: ${student.classroom}</span>`
        }
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// ì—”í„°í‚¤ë¡œ ê²€ìƒ‰ ì‹¤í–‰
document.getElementById('studentSearchInput').addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    searchStudent();
  }
});
    function sendFeedback() {
      const subject = document.getElementById("feedbackSubject").value.trim();
      const content = document.getElementById("feedbackContent").value.trim();
      
      if (!subject) {
        alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      if (!content) {
        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      const typeKorean = currentFeedbackType === "bug" ? "ë²„ê·¸ ë³´ê³ " : "ê°œì„  ê±´ì˜";
      
      google.script.run
        .withSuccessHandler(result => {
          alert(`âœ… ${result}`);
          closeFeedbackModal();
        })
        .withFailureHandler(error => {
          alert(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
        })
        .sendFeedbackEmail(typeKorean, subject, content);
    }

 // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    if (document.getElementById('feedbackModal').style.display === 'block') {
      closeFeedbackModal();
    }
    if (document.getElementById('studentSearchModal').style.display === 'block') {
      closeStudentSearchModal();
    }
  }
});

// ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
document.getElementById('feedbackModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeFeedbackModal();
  }
});

document.getElementById('studentSearchModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeStudentSearchModal();
  }
});
  </script>
</body>
</html>