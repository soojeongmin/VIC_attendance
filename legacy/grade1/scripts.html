<script>
// ì „ì—­ ë³€ìˆ˜
let studentMap = {};
let currentSeatId = null;
let longPressTimer = null;
let currentTimeSlot = null;
let isSaved = true;
let isSaving = false;
let currentFeedbackType = "";
let sleepPostItStudents = {};
let preAbsenceData = { ET: {}, EP1: {} }; // ì‚¬ì „ ê²°ì„ ì •ë³´
let allClassroomStatus = {
  '4A': { ET: {}, EP1: {}, EP2: {} },
  '4B': { ET: {}, EP1: {}, EP2: {} },
  '4C': { ET: {}, EP1: {}, EP2: {} },
  '4D': { ET: {}, EP1: {}, EP2: {} },
  'C407': { ET: {}, EP1: {}, EP2: {} },
  'C409': { ET: {}, EP1: {}, EP2: {} },
  'A401': { ET: {}, EP1: {}, EP2: {} },
  'A402': { ET: {}, EP1: {}, EP2: {} },
  'A408': { ET: {}, EP1: {}, EP2: {} }
};
let isFullyLoaded = false;
let isViolationSaving = false;
let tempSavedData = {};
let hasTempData = false;

const seatStatusByTimeSlot = {
  ET: {},
  EP1: {},
  EP2: {}
};

  function getCurrentDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function showGuideView() {
  const today = new Date().toISOString().slice(0, 10);
  const guideReadKey = `guideRead-${today}`;
  const hasRead = localStorage.getItem(guideReadKey);
  
  if (!hasRead) {
    document.getElementById("homeScreen").style.display = "none";
    document.getElementById("classroomView").style.display = "none";
    document.getElementById("statsView").style.display = "none";
    document.getElementById("guideView").style.display = "block";
    
    document.querySelector("header").style.display = "none";
    
    // ë¡œë”© ìƒíƒœ ë©”ì‹œì§€ ì¶”ê°€ (ì„ íƒì )
    const guideContent = document.getElementById("guideView");
    if (!guideContent.querySelector("#loadingStatus")) {
      const loadingStatus = document.createElement("div");
      loadingStatus.id = "loadingStatus";
      loadingStatus.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: #4CAF50;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 0.9em;
        z-index: 1000;
        display: none;
      `;
      loadingStatus.textContent = "ë°ì´í„° ë¡œë”© ì¤‘...";
      document.body.appendChild(loadingStatus);
    }
    
    return true; // ì•ˆë‚´ í™”ë©´ì„ í‘œì‹œí–ˆìŒì„ ë°˜í™˜
  }
  return false; // ì•ˆë‚´ í™”ë©´ì„ í‘œì‹œí•˜ì§€ ì•Šì•˜ìŒì„ ë°˜í™˜
}
// ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
function updateSleepPostItButton(student) {
  const sleepBtn = document.getElementById("sleepPostItBtn");
  
  if (!student) {
    sleepBtn.textContent = "ğŸ˜´ í•™ìƒ ì •ë³´ ì—†ìŒ";
    sleepBtn.disabled = true;
    sleepBtn.className = "";
    return;
  }
  
  if (sleepPostItStudents[student.studentId]) {
    // ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê²½ìš° - ì·¨ì†Œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ (ì‹œì‘ ì‹œê°„ í‘œì‹œ)
    const startTime = sleepPostItStudents[student.studentId].time;
    sleepBtn.textContent = `ğŸ˜´ ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ì·¨ì†Œ (ì‹œì‘: ${startTime})`;
    sleepBtn.disabled = false;
    sleepBtn.className = "using";
  } else {
    // ì•„ì§ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²½ìš° - ì‚¬ìš© ë²„íŠ¼
    sleepBtn.textContent = "ğŸ˜´ ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ì‚¬ìš©";
    sleepBtn.disabled = false;
    sleepBtn.className = "available";
  }
}
function closeGuideView() {
  const checkbox = document.getElementById("guideConfirm");
  if (checkbox.checked) {
    const today = new Date().toISOString().slice(0, 10);
    const guideReadKey = `guideRead-${today}`;
    localStorage.setItem(guideReadKey, "true");
    
    // ì•ˆë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°
    document.getElementById("guideView").style.display = "none";
    
    // êµì‹¤ì—ì„œ ì—´ì—ˆëŠ”ì§€ í™•ì¸
    const fromClassroom = document.getElementById("guideView").dataset.fromClassroom === "true";
    
    // ë°ì´í„° ë¡œë”©ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (isFullyLoaded) {
      // ì´ë¯¸ ë¡œë”© ì™„ë£Œ - ë°”ë¡œ í™”ë©´ í‘œì‹œ
      if (fromClassroom) {
        document.getElementById("classroomView").style.display = "block";
      } else {
        document.getElementById("homeScreen").style.display = "block";
      }
      // í—¤ë” ë‹¤ì‹œ í‘œì‹œ
      document.querySelector("header").style.display = "flex";
    } else {
      // ì•„ì§ ë¡œë”© ì¤‘ - ë¡œë”© í™”ë©´ í‘œì‹œ
      showLoading("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
      
      // í—¤ë”ëŠ” ìˆ¨ê¸´ ìƒíƒœ ìœ ì§€
      document.querySelector("header").style.display = "none";
      
      // ë¡œë”© ì™„ë£Œ ëŒ€ê¸°
      const checkInterval = setInterval(() => {
        if (isFullyLoaded) {
          clearInterval(checkInterval);
          hideLoading();
          
          // í—¤ë” í‘œì‹œ
          document.querySelector("header").style.display = "flex";
          
          if (fromClassroom) {
            document.getElementById("classroomView").style.display = "block";
          } else {
            document.getElementById("homeScreen").style.display = "block";
          }
        }
      }, 100);
    }
    
    // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
    checkbox.checked = false;
    document.getElementById("guideCloseBtn").disabled = true;
    document.getElementById("guideCloseBtn").style.background = "#ccc";
    document.getElementById("guideCloseBtn").style.cursor = "not-allowed";
  }
}

// ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ í™•ì¸ ë²„íŠ¼ í™œì„±í™”
document.getElementById("guideConfirm").addEventListener("change", function() {
  const confirmBtn = document.getElementById("guideCloseBtn");
  if (this.checked) {
    confirmBtn.disabled = false;
    confirmBtn.style.background = "#4CAF50";
    confirmBtn.style.cursor = "pointer";
  } else {
    confirmBtn.disabled = true;
    confirmBtn.style.background = "#ccc";
    confirmBtn.style.cursor = "not-allowed";
  }
});

function showGuideDirectly() {
  // í˜„ì¬ êµì‹¤ í™”ë©´ ìƒíƒœ ì €ì¥
  const wasInClassroom = document.getElementById("classroomView").style.display !== "none";
  
  // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê³  ì•ˆë‚´ í™”ë©´ë§Œ í‘œì‹œ
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("classroomView").style.display = "none";
  document.getElementById("statsView").style.display = "none";
  document.getElementById("guideView").style.display = "block";
  
  // êµì‹¤ì—ì„œ ì—´ì—ˆëŠ”ì§€ ê¸°ë¡
  document.getElementById("guideView").dataset.fromClassroom = wasInClassroom;
  
  // í—¤ë”ë„ ìˆ¨ê¸°ê¸°
  document.querySelector("header").style.display = "none";
  
  // ì²´í¬ë°•ìŠ¤ëŠ” ì´ˆê¸°í™” (ë‹¤ì‹œ ì²´í¬í•˜ë„ë¡)
  document.getElementById("guideConfirm").checked = false;
  document.getElementById("guideCloseBtn").disabled = true;
  document.getElementById("guideCloseBtn").style.background = "#ccc";
  document.getElementById("guideCloseBtn").style.cursor = "not-allowed";
}
function loadAllDataAtStart() {
  // ì•ˆë‚´ í™”ë©´ í‘œì‹œ (ë¡œë”©ì€ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ)
  const isGuideShown = showGuideView();

  // ë¡œë”©ì€ ë¬´ì¡°ê±´ ì‹œì‘ (ì•ˆë‚´ í™”ë©´ê³¼ ê´€ê³„ì—†ì´)
  console.log("ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ë¡œë”© ì‹œì‘...");

  const today = getCurrentDate();
  const mainClassrooms = ['4A', '4B', '4C', '4D'];
  const otherClassrooms = ['C407', 'C409', 'A401', 'A402', 'A408'];
  const timeSlots = ['ET', 'EP1', 'EP2'];

  let loadCount = 0;
  const totalLoads = 9 * 3 + 3; // 9ê°œ êµì‹¤ * 3ê°œ ì‹œê°„ëŒ€ + í•™ìƒë°ì´í„° + ìˆ˜ë©´í¬ìŠ¤íŠ¸ì‡ + ì‚¬ì „ê²°ì„ì •ë³´ = 30

  const checkLoadComplete = () => {
    loadCount++;
    const percent = Math.round((loadCount / totalLoads) * 100);
    console.log(`ë°ì´í„° ë¡œë”© ì§„í–‰: ${percent}% (${loadCount}/${totalLoads})`);

    if (loadCount >= totalLoads) {
      isFullyLoaded = true;
      console.log(`âœ… ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ!`);

      // ì•ˆë‚´ í™”ë©´ì´ ì´ë¯¸ ë‹«í˜”ìœ¼ë©´ í™ˆ í™”ë©´ í‘œì‹œ
      if (!isGuideShown || document.getElementById("guideView").style.display === "none") {
        document.getElementById("homeScreen").style.display = "block";
      }
    }
  };

  // 1. í•™ìƒ ë°ì´í„° ë¡œë“œ
  google.script.run
    .withSuccessHandler(data => {
      studentMap = data || {};
      console.log("í•™ìƒ ë°ì´í„° ë¡œë“œ ì„±ê³µ");
      checkLoadComplete();
    })
    .withFailureHandler((error) => {
      console.error("í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
      studentMap = {};
      checkLoadComplete();
    })
    .getStudentMap();

  // 2. ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ
  google.script.run
    .withSuccessHandler(data => {
      sleepPostItStudents = data || {};
      console.log("ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ ì„±ê³µ");
      checkLoadComplete();
    })
    .withFailureHandler((error) => {
      console.error("ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ ì‹¤íŒ¨:", error);
      sleepPostItStudents = {};
      checkLoadComplete();
    })
    .loadSleepPostItData();

  // 3. ì‚¬ì „ ê²°ì„ ì •ë³´ ë¡œë“œ
  google.script.run
    .withSuccessHandler(data => {
      preAbsenceData = data || { ET: {}, EP1: {} };
      console.log("ì‚¬ì „ ê²°ì„ ì •ë³´ ë¡œë“œ ì„±ê³µ - ET:", Object.keys(preAbsenceData.ET).length, "ëª…, EP1:", Object.keys(preAbsenceData.EP1).length, "ëª…");
      checkLoadComplete();
    })
    .withFailureHandler((error) => {
      console.error("ì‚¬ì „ ê²°ì„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);
      preAbsenceData = { ET: {}, EP1: {} };
      checkLoadComplete();
    })
    .getPreAbsenceData();

  // 4. ëª¨ë“  êµì‹¤ ë°ì´í„° ë¡œë“œ
  const allClassrooms = [...mainClassrooms, ...otherClassrooms];

  allClassrooms.forEach(classroom => {
    timeSlots.forEach(slot => {
      google.script.run
        .withSuccessHandler(statusMap => {
          if (!allClassroomStatus[classroom]) {
            allClassroomStatus[classroom] = { ET: {}, EP1: {}, EP2: {} };
          }
          allClassroomStatus[classroom][slot] = statusMap || {};
          console.log(`${classroom} ${slot} ë¡œë“œ ì„±ê³µ`);
          checkLoadComplete();
        })
        .withFailureHandler((error) => {
          console.error(`${classroom} ${slot} ë¡œë“œ ì‹¤íŒ¨:`, error);
          if (!allClassroomStatus[classroom]) {
            allClassroomStatus[classroom] = { ET: {}, EP1: {}, EP2: {} };
          }
          allClassroomStatus[classroom][slot] = {};
          checkLoadComplete();
        })
        .getSeatStatusMap(today, slot, classroom);
    });
  });
}
function showLoading(message = "ë¡œë”© ì¤‘...") {
  // ê¸°ì¡´ ë¡œë”© ì œê±°
  hideLoading();
  
  const loadingDiv = document.createElement("div");
  loadingDiv.id = "loadingOverlay";
  loadingDiv.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  `;
  
  const loadingContent = document.createElement("div");
  loadingContent.style.cssText = `
    background: white;
    padding: 20px 40px;
    border-radius: 10px;
    font-size: 1.2em;
  `;
  loadingContent.textContent = message;
  
  loadingDiv.appendChild(loadingContent);
  document.body.appendChild(loadingDiv);
}

function hideLoading() {
  const loading = document.getElementById("loadingOverlay");
  if (loading) {
    loading.remove();
  }
}
// ì•± ì‹œì‘ ì‹œ ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ í™•ì¸




// ESC í‚¤ ì´ë²¤íŠ¸ ìˆ˜ì • (ì•ˆë‚´ ëª¨ë‹¬ì€ ESCë¡œ ë‹«ì„ ìˆ˜ ì—†ë„ë¡)
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    if (document.getElementById('infoModal').style.display === 'block') {
      closeModal();
    }
    if (document.getElementById('feedbackModal').style.display === 'block') {
      closeFeedbackModal();
    }
    // guideModalì€ ESCë¡œ ë‹«ì„ ìˆ˜ ì—†ìŒ
  }
});
  
function selectTimeSlot(slot) {
  currentTimeSlot = slot;
  
  document.querySelectorAll(".time-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.slot === slot);
  });

  if (document.getElementById("classroomView").style.display !== "none") {
    const classroom = getCurrentClassroom();
    const date = getCurrentDate();
    const tempKey = `${date}_${classroom}_${slot}`;
    
    // 1. ë¨¼ì € ëª¨ë“  ì¢Œì„ì„ ë¯¸ì²´í¬ë¡œ ì´ˆê¸°í™”
    document.querySelectorAll(".seat").forEach(btn => {
      if (!btn.disabled && !["ë°œì „ì‹¤", "ì†Œëª…ì¤‘", "ë¯¸ë°°ì •"].includes(btn.dataset.status)) {
        btn.dataset.status = "ë¯¸ì²´í¬";
        btn.querySelector(".seatStatus").innerText = "[ë¯¸ì²´í¬]";
        btn.style.backgroundColor = "#fff3cd";
      }
    });
    
    // 2. ì„ì‹œì €ì¥ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì ìš©
    if (tempSavedData[tempKey] && tempSavedData[tempKey].status) {
      console.log(`ì„ì‹œì €ì¥ ë°ì´í„° ì ìš©: ${slot}`);
      Object.keys(tempSavedData[tempKey].status).forEach(seatId => {
        const btn = document.querySelector(`button[data-seat-id="${seatId}"]`);
        if (btn && !btn.disabled) {
          const status = tempSavedData[tempKey].status[seatId];
          btn.dataset.status = status;
          btn.querySelector(".seatStatus").innerText = `[${status}]`;
          btn.style.backgroundColor = status === "ì¶œì„" ? "#a5d8ff" : "#ccc";
          
          // ìºì‹œì—ë„ ë™ê¸°í™”
          if (!allClassroomStatus[classroom]) {
            allClassroomStatus[classroom] = { ET: {}, EP1: {}, EP2: {} };
          }
          if (!allClassroomStatus[classroom][slot]) {
            allClassroomStatus[classroom][slot] = {};
          }
          allClassroomStatus[classroom][slot][seatId] = { status: status };
        }
      });
    }
    // 3. ì„ì‹œì €ì¥ì´ ì—†ê³  ìºì‹œê°€ ìˆìœ¼ë©´ ìºì‹œ ì ìš©
    else if (allClassroomStatus[classroom] && 
             allClassroomStatus[classroom][slot] && 
             Object.keys(allClassroomStatus[classroom][slot]).length > 0) {
      console.log(`ìºì‹œ ë°ì´í„° ì ìš©: ${slot}`);
      applySeatStatus(allClassroomStatus[classroom][slot]);
    }
    
    updateSleepPostItDisplay();
    updateTempSaveButton();
  }
}
// í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ì‹œê°„ëŒ€ ë°˜í™˜
function getTimeSlotByCurrentTime() {
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const currentTime = hours * 60 + minutes; // ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
  
  console.log("í˜„ì¬ ì‹œê°:", now.toLocaleTimeString('ko-KR'));
  console.log("ì‹œê°„:", hours, "ë¶„:", minutes, "ì´ ë¶„:", currentTime);
  
  // ì‹œê°„ëŒ€ ì„¤ì • (10ë¶„ ì „ë¶€í„° í•´ë‹¹ ì‹œê°„ëŒ€ í‘œì‹œ)
// ìƒˆë²½ 0ì‹œ~3ì‹œëŠ” ì „ë‚ ì˜ EP2ë¡œ ì²˜ë¦¬
if (currentTime >= 0 && currentTime < 3 * 60) {
  console.log("ì„ íƒëœ ì‹œê°„ëŒ€: EP2 (ìƒˆë²½)");
  return "EP2";
} else if (currentTime >= 16 * 60 + 40 && currentTime < 19 * 60 + 10) {
  console.log("ì„ íƒëœ ì‹œê°„ëŒ€: ET");
  return "ET";
} else if (currentTime >= 19 * 60 + 10 && currentTime < 21 * 60) {
  console.log("ì„ íƒëœ ì‹œê°„ëŒ€: EP1");
  return "EP1";
} else if (currentTime >= 21 * 60) {
  console.log("ì„ íƒëœ ì‹œê°„ëŒ€: EP2");
  return "EP2";
} else {
  console.log("ì„ íƒëœ ì‹œê°„ëŒ€: ET (ê¸°ë³¸ê°’)");
  return "ET";
}}
    function openStats() {
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("classroomView").style.display = "none";
  document.getElementById("statsView").style.display = "block";

  // statsView ìŠ¤íƒ€ì¼ ê°œì„ 
  const statsView = document.getElementById("statsView");
  statsView.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">ğŸ“Š ì¶œê²° í†µê³„</h2>
      
      <div style="display: flex; gap: 20px; justify-content: center; align-items: center; margin-bottom: 30px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; color: #333;">ë‚ ì§œ:</label>
          <input type="date" id="statsDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" />
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; color: #333;">ë°˜(HR):</label>
          <select id="hrSelect" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; min-width: 100px;"></select>
        </div>
        
        <button onclick="loadAttendanceStats()" style="background: #2c3e50; color: white; padding: 10px 30px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold;">ì¡°íšŒ</button>
      </div>
      
      <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 5px;">
          <span style="font-size: 1.3em; color: #4CAF50;">â˜‘</span>
          <span>ì¶œì„</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <span style="font-size: 1.3em; color: #f44336;">â˜</span>
          <span>ê²°ì„</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <span style="font-size: 1.3em; color: #f9c74f;">?</span>
          <span>ë¯¸ì²´í¬</span>
        </div>
      </div>
      
      <div id="statsTable"></div>
    </div>
  `;

  // ê¸°ë³¸ ë‚ ì§œ = í•˜ë£¨ ì „ë‚ 
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  document.getElementById("statsDate").value = yesterday.toISOString().slice(0, 10);

  // HR ëª©ë¡ ìë™ ìƒì„±
  const select = document.getElementById("hrSelect");
  select.innerHTML = '<option value="">--ì„ íƒ--</option>';
  for (let i = 1; i <= 12; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i + "ë°˜";
    select.appendChild(option);
  }
}
    function loadAttendanceStats() {
      const date = document.getElementById("statsDate").value;
      const hr = document.getElementById("hrSelect").value;

      if (!date || !hr) {
        alert("ë‚ ì§œì™€ ë°˜(HR)ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      google.script.run
        .withSuccessHandler(drawStatsTable)
        .withFailureHandler(e => alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message))
        .getHrAttendanceStats(date, hr);
    }

    function drawStatsTable(data) {
  const container = document.getElementById("statsTable");
  if (!data || data.length === 0) {
    container.innerHTML = "<p style='text-align: center; color: #666;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  let html = `
    <style>
      .stats-table {
        width: 100%;
        max-width: 1000px;
        margin: 20px auto;
        border-collapse: collapse;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        background: white;
      }
      .stats-table th {
        background: #2c3e50;
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        position: sticky;
        top: 0;
      }
      .stats-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }
      .stats-table tr:hover {
        background: #f5f5f5;
      }
      .attendance-icon {
        font-size: 1.3em;
        font-weight: bold;
      }
      .attendance-present {
        color: #4CAF50;
      }
      .attendance-absent {
        color: #f44336;
      }
      .attendance-unchecked {
        color: #FF9800;
      }
      .violation-btn {
        background: #ff5252;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
      }
      .violation-btn:hover {
        background: #d32f2f;
        transform: scale(1.05);
      }
      .no-violation {
        color: #999;
        font-size: 0.9em;
      }
      @media (max-width: 768px) {
        .stats-table {
          font-size: 0.9em;
        }
        .stats-table th, .stats-table td {
          padding: 8px 4px;
        }
      }
    </style>
    <table class="stats-table">
      <thead>
        <tr>
          <th>í•™ë²ˆ</th>
          <th>ì´ë¦„</th>
          <th>í˜„ì¬ ì¢Œì„</th>
          <th>ET</th>
          <th>EP1</th>
          <th>EP2</th>
          <th>íŠ¹ì´ì‚¬í•­</th>
        </tr>
      </thead>
      <tbody>`;

  data.forEach(row => {
    const hasViolation = row.violationNote && row.violationNote.trim() !== "";
    
    // ì¶œê²° ìƒíƒœë¥¼ ì•„ì´ì½˜ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    const getAttendanceIcon = (status) => {
      switch(status) {
        case "ì¶œì„":
          return '<span class="attendance-icon attendance-present">â˜‘</span>';
        case "ê²°ì„":
          return '<span class="attendance-icon attendance-absent">â˜</span>';
        case "ë¯¸ì²´í¬":
        default:
          return '<span class="attendance-icon attendance-unchecked">?</span>';
      }
    };
    
    html += `
      <tr>
        <td style="font-weight: bold;">${row.studentId}</td>
        <td style="font-weight: bold;">${row.name}</td>
        <td style="color: #666;">${row.seat}</td>
        <td>${getAttendanceIcon(row.et)}</td>
        <td>${getAttendanceIcon(row.ep1)}</td>
        <td>${getAttendanceIcon(row.ep2)}</td>
        <td>
          ${hasViolation
            ? `<button class="violation-btn" onclick="showViolationDetail('${row.studentId}', '${row.name}', \`${row.violationNote.replace(/'/g, "\\'").replace(/\n/g, '\\n')}\`)">í™•ì¸</button>`
            : '<span class="no-violation">-</span>'}
        </td>
      </tr>`;
  });

  html += `
      </tbody>
    </table>`;
  
  container.innerHTML = html;
}

// íŠ¹ì´ì‚¬í•­ ìƒì„¸ ë³´ê¸° í•¨ìˆ˜ ì¶”ê°€
function showViolationDetail(studentId, name, note) {
  const formattedNote = note.replace(/\\n/g, '\n');
  alert(`[${name} (${studentId})] íŠ¹ì´ì‚¬í•­\n\n${formattedNote}`);
}

function loadTodayViolations(studentId) {
  const today = getCurrentDate();
  
  // ë¡œë”© í‘œì‹œ (ì„ íƒì‚¬í•­)
  const container = document.getElementById("todayViolations");
  const list = document.getElementById("violationsList");
  
  if (!container || !list) {
    console.error("ìœ„ë°˜ì‚¬í•­ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  
  // ë¡œë”© ì¤‘ í‘œì‹œ
  list.innerHTML = '<div style="text-align: center; color: #666;">ë¡œë”© ì¤‘...</div>';
  
  google.script.run
    .withSuccessHandler(violations => {
      if (violations && violations.length > 0) {
        container.style.display = "block";
        
        let html = "";
        violations.forEach((v, index) => {
          html += `
            <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${v.timeSlot}</strong> - ${v.violationType}
                ${v.recordTime ? `<span style="color: #888; font-size: 0.9em;">(${v.recordTime})</span>` : ''}
                ${v.note ? `<br><small style="color: #666;">${v.note}</small>` : ''}
              </div>
              <button onclick="deleteViolation('${v.rowIndex}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ì‚­ì œ</button>
            </div>
          `;
        });
        list.innerHTML = html;
      } else {
        container.style.display = "none";
        list.innerHTML = "";
      }
    })
    .withFailureHandler(error => {
      console.error("ìœ„ë°˜ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:", error);
      container.style.display = "none";
      alert("ìœ„ë°˜ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    })
    .getTodayViolations(studentId, today);
}

// ìœ„ë°˜ì‚¬í•­ ì‚­ì œ
function deleteViolation(rowIndex) {
  if (confirm("ì •ë§ë¡œ ì´ ìœ„ë°˜ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    showLoading("ì‚­ì œ ì¤‘...");
    
    google.script.run
      .withSuccessHandler(() => {
        hideLoading();
        alert("âœ… ìœ„ë°˜ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // í˜„ì¬ í•™ìƒì˜ ìœ„ë°˜ì‚¬í•­ ë‹¤ì‹œ ë¡œë“œ
        const student = studentMap[currentSeatId];
        if (student) {
          loadTodayViolations(student.studentId);
        }
      })
      .withFailureHandler(error => {
        hideLoading();
        alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
      })
      .deleteViolationRecord(rowIndex);
  }
}

function markAllSeats(status) {
  document.querySelectorAll(".seat").forEach(btn => {
    const seatId = btn.dataset.seatId;
    const current = btn.dataset.status;
    const student = studentMap[seatId];

    if (!btn.disabled && !["ë°œì „ì‹¤", "ì†Œëª…ì¤‘", "ë¯¸ë°°ì •"].includes(current)) {
      btn.dataset.status = status;
      
      const moveDateStr = student?.moveDate || "";
      const movedSeat = student?.movedSeat || "";
      const currentDateStr = getCurrentDate();
      const isBeforeMove = moveDateStr && currentDateStr < moveDateStr;
      const isAppeal = isBeforeMove && movedSeat;
      const currentClassroom = getCurrentClassroom();
      const isDevRoom = ["A401", "A402"].includes(currentClassroom);
      
      let displayStatus = status;
      if (isAppeal && !isDevRoom && status === "ë¯¸ì²´í¬") {
        displayStatus = "ì†Œëª…ì¤‘";
      }
      
      btn.querySelector(".seatStatus").innerText = `[${displayStatus}]`;
      btn.style.backgroundColor =
        status === "ì¶œì„" ? "#a5d8ff" :
        status === "ê²°ì„" ? "#ccc" : "#fff3cd";
    }
  });

  // autoSaveTempData(); â† ì œê±°
  isSaved = false;
}
function resetAllClassrooms() {
  alert("ì¶œê²° ì´ˆê¸°í™”ëŠ” Google ì‹œíŠ¸ì—ì„œ ì§ì ‘ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.");
}

    // ë²„ê·¸/ì•„ì´ë””ì–´ íŒì—… (ë¯¸êµ¬í˜„)
function openModal(type) {
  currentFeedbackType = type;
  const title = type === "bug" ? "ğŸ ë²„ê·¸ ë³´ê³ " : "ğŸ’¡ ê°œì„  ê±´ì˜";
  
  document.getElementById("feedbackTitle").innerText = title;
  document.getElementById("feedbackSubject").value = "";
  document.getElementById("feedbackContent").value = "";
  document.getElementById("feedbackModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("infoModal").style.display = "none";
  
  // ëª¨ë“  ìš”ì†Œë¥¼ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
  const sleepBtn = document.getElementById("sleepPostItBtn");
  if (sleepBtn) {
    sleepBtn.style.display = "block";
  }
  
  document.getElementById("violationTypeLabel").style.display = "block";
  document.querySelector('label:has(#violationNote)').style.display = "block";
  
  const modalButtons = document.querySelector("#infoModal .modal-buttons");
  const saveBtn = modalButtons.querySelector('button[onclick="saveViolation()"]');
  if (saveBtn) {
    saveBtn.style.display = "inline-block";
  }
  
  const specialMsg = document.getElementById("specialRoomMessage");
  if (specialMsg) {
    specialMsg.style.display = "none";
  }
}
// í”¼ë“œë°± ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ ì¶”ê°€
function closeFeedbackModal() {
  document.getElementById("feedbackModal").style.display = "none";
  currentFeedbackType = "";
}
function showTutorial() {
  // í˜„ì¬ êµì‹¤ í™”ë©´ ìƒíƒœ ì €ì¥
  const wasInClassroom = document.getElementById("classroomView").style.display !== "none";
  
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("classroomView").style.display = "none";
  document.getElementById("statsView").style.display = "none";
  document.getElementById("guideView").style.display = "none";
  document.getElementById("tutorialView").style.display = "block";
  
  // êµì‹¤ì—ì„œ ì—´ì—ˆëŠ”ì§€ ê¸°ë¡
  document.getElementById("tutorialView").dataset.fromClassroom = wasInClassroom;
}


// íŠœí† ë¦¬ì–¼ ë‹«ê¸°
function closeTutorial() {
  document.getElementById("tutorialView").style.display = "none";
  
  // êµì‹¤ì—ì„œ ì—´ì—ˆëŠ”ì§€ í™•ì¸
  const fromClassroom = document.getElementById("tutorialView").dataset.fromClassroom === "true";
  
  if (fromClassroom) {
    document.getElementById("classroomView").style.display = "block";
  } else {
    document.getElementById("homeScreen").style.display = "block";
  }
}
// ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ ëª¨ë‹¬ ì—´ê¸°
function openGeneralFeedback() {
  currentFeedbackType = "general";
  const title = "ğŸ“ ê¸°íƒ€ íŠ¹ì´ì‚¬í•­";
  
  document.getElementById("feedbackTitle").innerText = title;
  document.getElementById("feedbackSubject").value = "";
  document.getElementById("feedbackContent").value = "";
  document.getElementById("feedbackModal").style.display = "flex";
}

// sendFeedback í•¨ìˆ˜ë¥¼ ì™„ì „íˆ êµì²´
function sendFeedback() {
  const subject = document.getElementById("feedbackSubject").value.trim();
  const content = document.getElementById("feedbackContent").value.trim();
  
  if (!subject) {
    alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  if (!content) {
    alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  showLoading("ì €ì¥ ì¤‘...");
  
  // ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ì¸ ê²½ìš° ì‹œíŠ¸ì— ì €ì¥
  if (currentFeedbackType === "general") {
    const data = {
      timeSlot: currentTimeSlot || "ET",  // í˜„ì¬ ì‹œê°„ëŒ€, ì—†ìœ¼ë©´ ET ê¸°ë³¸ê°’
      subject: subject,
      content: content
    };
    
    google.script.run
      .withSuccessHandler(result => {
        hideLoading();
        alert(`âœ… ${result}`);
        closeFeedbackModal();
      })
      .withFailureHandler(error => {
        hideLoading();
        alert(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      })
      .saveGeneralNote(data);
  } 
  // ë²„ê·¸ ë³´ê³ ë‚˜ ê°œì„  ê±´ì˜ëŠ” ê¸°ì¡´ëŒ€ë¡œ ë©”ì¼ ì „ì†¡
  else {
    let typeKorean;
    if (currentFeedbackType === "bug") {
      typeKorean = "ë²„ê·¸ ë³´ê³ ";
    } else if (currentFeedbackType === "idea") {
      typeKorean = "ê°œì„  ê±´ì˜";
    }
    
    google.script.run
      .withSuccessHandler(result => {
        hideLoading();
        alert(`âœ… ${result}`);
        closeFeedbackModal();
      })
      .withFailureHandler(error => {
        hideLoading();
        alert(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`);
      })
      .sendFeedbackEmail(typeKorean, subject, content);
  }
}


// ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰)
function loadSleepPostItData() {
  google.script.run
    .withSuccessHandler(data => {
      sleepPostItStudents = data || {};
      updateSleepPostItDisplay();
    })
    .withFailureHandler(error => {
      console.error("ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë¡œë“œ ì‹¤íŒ¨:", error);
      sleepPostItStudents = {};
    })
    .loadSleepPostItData();
}

// ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë°ì´í„° ì €ì¥
function saveSleepPostItData() {
  google.script.run
    .withSuccessHandler(() => {
      console.log("ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ì €ì¥ ì™„ë£Œ");
    })
    .withFailureHandler(error => {
      console.error("ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ì €ì¥ ì‹¤íŒ¨:", error);
    })
    .saveSleepPostItData(sleepPostItStudents);
}
function toggleSleepPostIt() {
  if (!currentSeatId) return;
  
  const student = studentMap[currentSeatId];
  if (!student) return;
  
  const studentId = student.studentId;
  
  // ì´ë¯¸ ì‚¬ìš©í–ˆëŠ”ì§€ í™•ì¸
  // ì‚¬ì „ ê²°ì„ ì—¬ë¶€ í™•ì¸
  const absenceSheet = currentTimeSlot === "ET" ? "ET" : "EP1";
  const hasPreAbsence = preAbsenceData[absenceSheet] && preAbsenceData[absenceSheet][studentId];

  if (sleepPostItStudents[studentId]) {
    // ì·¨ì†Œ í™•ì¸
    if (confirm(`${student.name} í•™ìƒì˜ ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      delete sleepPostItStudents[studentId];
      saveSleepPostItData();

      // UI ì—…ë°ì´íŠ¸ - ë³µí•© ìƒíƒœ ì²˜ë¦¬
      const seatBtn = document.querySelector(`button[data-seat-id="${currentSeatId}"]`);
      if (seatBtn) {
        seatBtn.classList.remove('sleep-postit', 'sleep-and-absence');
        if (hasPreAbsence) {
          seatBtn.classList.add('pre-absence');
        }
      }

      // alert ì œê±° - ë°”ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      closeModal();
    }
    return;
  }

  // ìƒˆë¡œ ë“±ë¡
  sleepPostItStudents[studentId] = {
    seatId: currentSeatId,
    name: student.name,
    time: new Date().toLocaleTimeString('ko-KR')
  };

  saveSleepPostItData();

  // UI ì—…ë°ì´íŠ¸ - ë³µí•© ìƒíƒœ ì²˜ë¦¬
  const seatBtn = document.querySelector(`button[data-seat-id="${currentSeatId}"]`);
  if (seatBtn) {
    seatBtn.classList.remove('pre-absence');
    if (hasPreAbsence) {
      seatBtn.classList.add('sleep-and-absence');
    } else {
      seatBtn.classList.add('sleep-postit');
    }
  }

  alert(`âœ… ${student.name} í•™ìƒì˜ ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‹œì‘ ì‹œê°„: ${sleepPostItStudents[studentId].time}`);

  // ëª¨ë‹¬ ë‹«ê¸°
  closeModal();
}
// í•™ìƒ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
function openStudentSearch() {
  document.getElementById("studentSearchInput").value = "";
  document.getElementById("searchResults").innerHTML = "";
  document.getElementById("studentSearchModal").style.display = "flex";
}

// í•™ìƒ ê²€ìƒ‰ ëª¨ë‹¬ ë‹«ê¸°
function closeStudentSearchModal() {
  document.getElementById("studentSearchModal").style.display = "none";
}

// í•™ìƒ ê²€ìƒ‰ ì‹¤í–‰
function searchStudent() {
  const searchName = document.getElementById("studentSearchInput").value.trim();
  
  if (!searchName) {
    alert("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }
  
  showLoading("ê²€ìƒ‰ ì¤‘...");
  
  google.script.run
    .withSuccessHandler(results => {
      hideLoading();
      displaySearchResults(results);
    })
    .withFailureHandler(error => {
      hideLoading();
      alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + error.message);
    })
    .searchStudentByName(searchName);
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function displaySearchResults(results) {
  const container = document.getElementById("searchResults");
  
  if (!results || results.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  let html = '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px;">';
  
  results.forEach((student, index) => {
    const isDevRoom = student.movedSeat && student.moveDate;
    const currentDate = new Date().toISOString().slice(0, 10);
    const isMoved = isDevRoom && currentDate >= student.moveDate;
    
    html += `
      <div style="padding: 10px; ${index > 0 ? 'border-top: 1px solid #eee;' : ''} background: ${isMoved ? '#ffebee' : '#f5f5f5'}; margin-bottom: 5px; border-radius: 4px;">
        <strong style="color: #2c3e50;">${student.name}</strong><br>
        <span style="color: #666;">í•™ë²ˆ: ${student.studentId}</span><br>
        <span style="color: #666;">HR: ${student.hr || '-'}</span><br>
        ${isMoved ? 
          `<span style="color: #d32f2f; font-weight: bold;">ğŸ“ ë°œì „ì‹¤: ${student.movedSeat}</span><br>
           <span style="color: #d32f2f;">ì´ë™ì¼: ${student.moveDate}</span>` :
          `<span style="color: #388e3c;">ğŸ“ ì¢Œì„: ${student.seat}</span><br>
           <span style="color: #388e3c;">êµì‹¤: ${student.classroom}</span>`
        }
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// ESC í‚¤ ì´ë²¤íŠ¸ì— í•™ìƒ ê²€ìƒ‰ ëª¨ë‹¬ ì¶”ê°€
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    if (document.getElementById('studentSearchModal').style.display === 'block') {
      closeStudentSearchModal();
    }
    // ê¸°ì¡´ ëª¨ë‹¬ë“¤...
  }
});

// ì—”í„°í‚¤ë¡œ ê²€ìƒ‰ ì‹¤í–‰
document.getElementById('studentSearchInput').addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    searchStudent();
  }
});
function updateSleepPostItDisplay() {
  document.querySelectorAll(".seat").forEach(btn => {
    const seatId = btn.dataset.seatId;
    const student = studentMap[seatId];

    // ê¸°ì¡´ í…Œë‘ë¦¬ í´ë˜ìŠ¤ ëª¨ë‘ ì œê±°
    btn.classList.remove('sleep-postit', 'pre-absence', 'sleep-and-absence');

    if (!student) return;

    const hasSleepPostIt = sleepPostItStudents[student.studentId];
    const absenceSheet = currentTimeSlot === "ET" ? "ET" : "EP1";
    const hasPreAbsence = preAbsenceData[absenceSheet] && preAbsenceData[absenceSheet][student.studentId];

    if (hasSleepPostIt && hasPreAbsence) {
      // ë‘˜ ë‹¤ í•´ë‹¹: ì£¼í™©ìƒ‰ í…Œë‘ë¦¬
      btn.classList.add('sleep-and-absence');
    } else if (hasSleepPostIt) {
      // ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ë§Œ: ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬
      btn.classList.add('sleep-postit');
    } else if (hasPreAbsence) {
      // ì‚¬ì „ ê²°ì„ë§Œ: ë…¸ë€ìƒ‰ í…Œë‘ë¦¬
      btn.classList.add('pre-absence');
    }
  });
}
function saveViolation() {
  if (isViolationSaving) {
    alert("ì´ë¯¸ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
    return;
  }

  const violationType = document.getElementById("violationType").value;
  const violationNote = document.getElementById("violationNote").value.trim();
  const student = studentMap[currentSeatId];

  if (!student) {
    alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  if (!violationType) {
    alert("ìœ„ë°˜ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  if (!violationNote) {
    alert("ì ë°œìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! ìì„¸í• ìˆ˜ë¡ ì¢‹ìŠµë‹ˆë‹¤!\n(ì˜ˆ: ë‘ë“œë ¤ë„ ê¹¨ìš°ì§€ ëª»í•  ì •ë„ë¡œ ì—ë“œë ¤ì , ëª°ë˜ ìœ íŠœë¸Œ ì‡¼ì¸  ì‹œì²­, ì¡°ëŠ” ê²ƒ ì—¬ëŸ¬ë²ˆ ì ë°œ)");
    return;
  }

  isViolationSaving = true;
  const saveBtn = document.querySelector("#infoModal button[onclick='saveViolation()']");
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.style.opacity = "0.5";
    saveBtn.textContent = "ì €ì¥ ì¤‘...";
  }

  const data = {
    seatNumber: student.seatNumber || currentSeatId,
    studentId: student.studentId || "",
    name: student.name || "",
    classroom: student.classroom || getCurrentClassroom(),
    violationType,
    note: violationNote,
    timeSlot: currentTimeSlot,
    email: student.email || ""
  };

  console.log("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ì‹œì‘:", data);

  google.script.run
    .withSuccessHandler(() => {
      console.log("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ì„±ê³µ");
      alert("âœ… ìœ„ë°˜ ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      
      isViolationSaving = false;
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = "1";
        saveBtn.textContent = "ì €ì¥";
      }
      
      closeModal();
    })
    .withFailureHandler(err => {
      console.error("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ì˜¤ë¥˜ ë°œìƒ:", err);
      console.error("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ì˜¤ë¥˜ íƒ€ì…:", typeof err);
      console.error("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ì˜¤ë¥˜ ê°ì²´:", JSON.stringify(err, null, 2));
      
      let errorMsg = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      let errorDetail = "";
      
      if (err && typeof err === 'object') {
        if (err.message) {
          errorMsg = err.message;
          errorDetail = `message: ${err.message}`;
        } else if (err.error) {
          errorMsg = err.error;
          errorDetail = `error: ${err.error}`;
        } else if (err.stack) {
          errorDetail = `stack: ${err.stack}`;
        }
        
        if (err.name) errorDetail += `, name: ${err.name}`;
        if (err.code) errorDetail += `, code: ${err.code}`;
      } else if (typeof err === 'string') {
        errorMsg = err;
        errorDetail = `string: ${err}`;
      }
      
      console.error("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ìµœì¢… ì˜¤ë¥˜ ë©”ì‹œì§€:", errorMsg);
      console.error("[ìœ„ë°˜ì‚¬í•­ ì €ì¥] ì˜¤ë¥˜ ìƒì„¸:", errorDetail);
      
      alert(`âŒ ìœ„ë°˜ì‚¬í•­ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\nì˜¤ë¥˜: ${errorMsg}\n\nìƒì„¸: ${errorDetail}\n\nì‹œê°: ${new Date().toLocaleString('ko-KR')}`);
      
      isViolationSaving = false;
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = "1";
        saveBtn.textContent = "ì €ì¥";
      }
    })
    .saveViolationRecord(data);
}
    // í˜„ì¬ êµì‹¤ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    function getCurrentClassroom() {
      return document.getElementById("classroomTitle")
        .innerText.replace(" êµì‹¤", "");
    }

function loadSeatStatus() {
  const date = getCurrentDate();
  const classroom = getCurrentClassroom();
  
  google.script.run
    .withSuccessHandler(statusMap => {
      applySeatStatus(statusMap);
      hideLoading();
    })
    .withFailureHandler(e => {
      hideLoading();
      // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ êµ¬ë¶„
      if (e.message.includes("undefined") || e.message.includes("network") || e.message.includes("Failed")) {
        alert("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.\n\nWi-Fi ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      } else {
        alert("ì¢Œì„ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message);
      }
    })
    .getSeatStatusMap(date, currentTimeSlot, classroom);
}
function applySeatStatus(statusMap) {
  const currentSlot = document.querySelector(".time-btn.active")?.dataset.slot;
  console.log(`applySeatStatus í˜¸ì¶œ: í˜„ì¬ ì‹œê°„ëŒ€ = ${currentSlot}`);
  console.log(`ì ìš©í•  ë°ì´í„°:`, statusMap);
  
  document.querySelectorAll(".seat").forEach(btn => {
    const seatId = btn.querySelector(".seatId")?.innerText;
    const student = studentMap[seatId];
    const st = statusMap[seatId];
    
    // ë°œì „ì‹¤/ì†Œëª…ì¤‘ ì²´í¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if (student) {
      const moveDateStr = student.moveDate || "";
      const movedSeat = student.movedSeat || "";
      const currentDateStr = getCurrentDate();
      const currentClassroom = getCurrentClassroom();
      const isDevRoom = ["A401", "A402", "A408"].includes(currentClassroom);
      
      if (!isDevRoom && moveDateStr && currentDateStr >= moveDateStr && movedSeat) {
        btn.dataset.status = "ë°œì „ì‹¤";
        btn.querySelector(".seatStatus").innerText = "[ë°œì „ì‹¤]";
        btn.style.backgroundColor = "#ff9999";
        btn.disabled = true;
        btn.style.opacity = 0.4;
        btn.style.cursor = "not-allowed";
        return;
      }
      
      if (moveDateStr && currentDateStr < moveDateStr && movedSeat) {
        if (isDevRoom) {
          btn.dataset.status = "ì†Œëª…ì¤‘";
          btn.querySelector(".seatStatus").innerText = "[ì†Œëª…ì¤‘]";
          btn.style.backgroundColor = "#eee";
          btn.disabled = true;
          btn.style.opacity = 0.4;
          btn.style.cursor = "not-allowed";
        } else {
          const nameSpan = btn.querySelector(".studentName");
          if (nameSpan) nameSpan.style.textDecoration = "underline";
          if (!st) {
            btn.querySelector(".seatStatus").innerText = "[ì†Œëª…ì¤‘]";
          }
        }
      }
    }
    
    // âœ… ì‹œíŠ¸ì˜ ì¶œê²° ìƒíƒœ ì ìš© (í•´ë‹¹ ì¢Œì„ì— ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ)
    if (st && st.status) {
      console.log(`${seatId}: ${st.status} ì ìš©`);
      btn.dataset.status = st.status;
      btn.querySelector(".seatStatus").innerText = `[${st.status}]`;
      btn.style.backgroundColor = st.status === "ì¶œì„" ? "#a5d8ff" : "#ccc";
    } else {
      // âœ… ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¯¸ì²´í¬ë¡œ ìœ ì§€ (ë°œì „ì‹¤/ì†Œëª…ì¤‘ ì œì™¸)
      if (!["ë°œì „ì‹¤", "ì†Œëª…ì¤‘", "ë¯¸ë°°ì •"].includes(btn.dataset.status)) {
        console.log(`${seatId}: ë°ì´í„° ì—†ìŒ - ë¯¸ì²´í¬ ìœ ì§€`);
      }
    }
  });
}

    function refreshStudentMap(callback) {
      google.script.run
        .withSuccessHandler(data => {
          studentMap = data;
          if (typeof callback === "function") callback();
        })
        .withFailureHandler(err => {
          console.error("í•™ìƒ ì •ë³´ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:", err);
          alert("âŒ í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        })
        .getStudentMap();
    }
function renderSeatLayout(layout) {
  const grid = document.getElementById("seatGrid");
  grid.innerHTML = "";
  layout.forEach(row => {
    if (row[0] === "br") {
      const br = document.createElement("div");
      br.style.height = "24px";
      grid.appendChild(br);
    } else {
      const rowDiv = document.createElement("div");
      rowDiv.className = "seat-row";
      row.forEach(cell => {
        if (cell === "sp") {
          const spacer = document.createElement("div");
          spacer.className = "spacer";
          rowDiv.appendChild(spacer);
        } else if (cell === "empty") {
          // íˆ¬ëª…í•œ ë²„íŠ¼ ìƒì„±
          const emptyBtn = document.createElement("button");
          emptyBtn.className = "seat empty-seat";
          emptyBtn.disabled = true;
          emptyBtn.innerHTML = `
            <span class="seatId"></span>
            <span class="studentName"></span>
            <span class="seatStatus"></span>
          `;
          rowDiv.appendChild(emptyBtn);
        } else {
          rowDiv.appendChild(createSeatButton(cell));
        }
      });
      grid.appendChild(rowDiv);
    }
  });
}

function showRefreshWarning() {
  // ê¸°ì¡´ ê²½ê³  ì œê±°
  const existingWarning = document.getElementById('refreshWarning');
  if (existingWarning) {
    existingWarning.remove();
  }
  
  // ê²½ê³  ë©”ì‹œì§€ ìƒì„±
  const warning = document.createElement('div');
  warning.id = 'refreshWarning';
  warning.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff5252;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    font-size: 16px;
    font-weight: bold;
    animation: slideDown 0.3s ease;
  `;
  warning.textContent = 'âš ï¸ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ì¤‘! ì €ì¥í•˜ì§€ ì•Šì€ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.';
  
  document.body.appendChild(warning);
  
  // 3ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    warning.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => {
      warning.remove();
    }, 300);
  }, 3000);
}

// ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
const style = document.createElement('style');
style.textContent = `
  @keyframes slideDown {
    from {
      top: -50px;
      opacity: 0;
    }
    to {
      top: 20px;
      opacity: 1;
    }
  }
  
  @keyframes slideUp {
    from {
      top: 20px;
      opacity: 1;
    }
    to {
      top: -50px;
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

    // íƒ­ì„ ì´ë™í•  ë•Œ ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœë¥¼ ì´ˆê¸°í™”
function goHome() {
  if (!isSaved) {
    const confirmSwitch = confirm("ì¶œê²°ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ í™ˆìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (!confirmSwitch) return;
  }

  isSaved = true;
  document.getElementById("homeScreen").style.display = "block";
  document.getElementById("classroomView").style.display = "none";
  document.getElementById("statsView").style.display = "none";
  document.getElementById("statsTable").innerHTML = "";
  
  // âœ… í—¤ë” ì¶œê²° ë²„íŠ¼ ìˆ¨ê¹€
  document.getElementById("headerAttendanceButtons").style.display = "none";
}
// ì„ì‹œì €ì¥ í•¨ìˆ˜
function tempSaveAttendance() {
  const classroom = getCurrentClassroom();
  const timeSlot = currentTimeSlot;
  const date = getCurrentDate();
  
  // í˜„ì¬ ì¶œê²° ìƒíƒœ ìˆ˜ì§‘
  const currentStatus = {};
  let hasData = false;
  
  document.querySelectorAll(".seat").forEach(btn => {
    const seatId = btn.dataset.seatId;
    const status = btn.dataset.status;
    
    if (!["ë°œì „ì‹¤", "ì†Œëª…ì¤‘", "ë¯¸ë°°ì •"].includes(status)) {
      currentStatus[seatId] = status;
      hasData = true;
    }
  });
  
  if (!hasData) {
    alert("ì €ì¥í•  ì¶œê²° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ì„ì‹œì €ì¥ í‚¤ ìƒì„±
  const tempKey = `${date}_${classroom}_${timeSlot}`;
  
  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
  if (!tempSavedData[tempKey]) {
    tempSavedData[tempKey] = {};
  }
  
  tempSavedData[tempKey] = {
    classroom: classroom,
    timeSlot: timeSlot,
    date: date,
    status: currentStatus,
    savedAt: new Date().toLocaleTimeString('ko-KR')
  };
  
  // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
  localStorage.setItem('tempAttendanceData', JSON.stringify(tempSavedData));
  hasTempData = true;
  
  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
  updateTempSaveButton();
  
  alert(`âœ… ì„ì‹œì €ì¥ ì™„ë£Œ!\n\nğŸ“ ${classroom} ${timeSlot}\nâ° ì €ì¥ì‹œê°„: ${tempSavedData[tempKey].savedAt}\n\nâš ï¸ ë„¤íŠ¸ì›Œí¬ê°€ ì•ˆì •ë˜ë©´ ë°˜ë“œì‹œ 'ì¶œê²°ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„œë²„ì— ì €ì¥í•´ì£¼ì„¸ìš”!`);
}

function loadTempSavedData() {
  const saved = localStorage.getItem('tempAttendanceData');
  if (saved) {
    try {
      tempSavedData = JSON.parse(saved);
      hasTempData = Object.keys(tempSavedData).length > 0;
      
      // ë‚ ì§œ ë³€ê²½ ì‹œ ì´ì „ ë°ì´í„° ì •ë¦¬ (7ì¼ â†’ ë‹¹ì¼ë§Œ ìœ ì§€)
      cleanOldTempData();
      
      // ì˜¤ëŠ˜ ì„ì‹œì €ì¥ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì•Œë¦¼
      if (hasTempData) {
        showTempDataNotification();
      }
    } catch (e) {
      console.error("ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
      tempSavedData = {};
      hasTempData = false;
    }
  }
}

function cleanOldTempData() {
  const today = new Date().toISOString().slice(0, 10); // ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD)
  
  let hasDeleted = false;
  Object.keys(tempSavedData).forEach(key => {
    const data = tempSavedData[key];
    // ì €ì¥ëœ ë‚ ì§œê°€ ì˜¤ëŠ˜ì´ ì•„ë‹ˆë©´ ëª¨ë‘ ì‚­ì œ
    if (data.date !== today) {
      delete tempSavedData[key];
      hasDeleted = true;
      console.log(`ì´ì „ ë‚ ì§œ ì„ì‹œì €ì¥ ì‚­ì œ: ${key}`);
    }
  });
  
  if (hasDeleted) {
    localStorage.setItem('tempAttendanceData', JSON.stringify(tempSavedData));
    hasTempData = Object.keys(tempSavedData).length > 0;
  }
}

// ì„ì‹œì €ì¥ ë°ì´í„° ì•Œë¦¼
function showTempDataNotification() {
  const count = Object.keys(tempSavedData).length;
  const notification = document.createElement('div');
  notification.id = 'tempDataNotification';
  notification.style.cssText = `
    position: fixed;
    top: 70px;
    right: 20px;
    background: #FF9800;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    font-weight: bold;
    cursor: pointer;
  `;
  notification.innerHTML = `ğŸ“‹ ì„ì‹œì €ì¥ëœ ì¶œê²° ${count}ê±´<br><small>í´ë¦­í•˜ì—¬ í™•ì¸</small>`;
  notification.onclick = showTempDataList;
  
  document.body.appendChild(notification);
  
  // 5ì´ˆ í›„ ìë™ ì œê±°
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// ì„ì‹œì €ì¥ ëª©ë¡ í‘œì‹œ
function showTempDataList() {
  let listHtml = '<h3>ğŸ“‹ ì„ì‹œì €ì¥ëœ ì¶œê²° ëª©ë¡</h3>';
  listHtml += '<div style="max-height: 300px; overflow-y: auto;">';
  
  Object.keys(tempSavedData).forEach(key => {
    const data = tempSavedData[key];
    listHtml += `
      <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
        <strong>${data.classroom} - ${data.timeSlot}</strong><br>
        ë‚ ì§œ: ${data.date}<br>
        ì €ì¥ì‹œê°„: ${data.savedAt}<br>
        <button onclick="loadTempData('${key}')" style="background: #4CAF50; color: white; margin-top: 5px;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="deleteTempData('${key}')" style="background: #f44336; color: white; margin-top: 5px;">ì‚­ì œ</button>
      </div>
    `;
  });
  
  listHtml += '</div>';
  listHtml += '<p style="color: #FF5722; font-weight: bold;">âš ï¸ ì„ì‹œì €ì¥ ë°ì´í„°ëŠ” ë°˜ë“œì‹œ ì„œë²„ì— ì €ì¥í•´ì£¼ì„¸ìš”!</p>';
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    max-width: 400px;
    width: 90%;
  `;
  modal.innerHTML = listHtml;
  modal.innerHTML += '<button onclick="this.parentElement.remove()" style="background: #666; color: white; width: 100%; margin-top: 10px;">ë‹«ê¸°</button>';
  
  document.body.appendChild(modal);
}

// íŠ¹ì • ì„ì‹œì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadTempData(key) {
  const data = tempSavedData[key];
  if (!data) {
    alert("ì„ì‹œì €ì¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // í•´ë‹¹ êµì‹¤ë¡œ ì´ë™
  openClassroom(data.classroom);
  
  // ì‹œê°„ëŒ€ ì„¤ì •
  setTimeout(() => {
    selectTimeSlot(data.timeSlot);
    
    // ì¶œê²° ìƒíƒœ ë³µì›
    setTimeout(() => {
      Object.keys(data.status).forEach(seatId => {
        const btn = document.querySelector(`button[data-seat-id="${seatId}"]`);
        if (btn && !btn.disabled) {
          const status = data.status[seatId];
          btn.dataset.status = status;
          btn.querySelector(".seatStatus").innerText = `[${status}]`;
          btn.style.backgroundColor = 
            status === "ì¶œì„" ? "#a5d8ff" :
            status === "ê²°ì„" ? "#ccc" : "#fff3cd";
        }
      });
      
      alert(`âœ… ì„ì‹œì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n\n${data.classroom} - ${data.timeSlot}\nì €ì¥ì‹œê°„: ${data.savedAt}\n\nâš ï¸ ë„¤íŠ¸ì›Œí¬ê°€ ì•ˆì •ë˜ë©´ 'ì¶œê²°ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!`);
      
      // ëª¨ë‹¬ ë‹«ê¸°
      const modals = document.querySelectorAll('div[style*="position: fixed"]');
      modals.forEach(m => {
        if (m.innerHTML.includes('ì„ì‹œì €ì¥ëœ ì¶œê²° ëª©ë¡')) {
          m.remove();
        }
      });
    }, 500);
  }, 500);
}

// íŠ¹ì • ì„ì‹œì €ì¥ ë°ì´í„° ì‚­ì œ
function deleteTempData(key) {
  if (confirm("ì´ ì„ì‹œì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    delete tempSavedData[key];
    localStorage.setItem('tempAttendanceData', JSON.stringify(tempSavedData));
    hasTempData = Object.keys(tempSavedData).length > 0;
    
    // ëª©ë¡ ë‹¤ì‹œ í‘œì‹œ
    const modals = document.querySelectorAll('div[style*="position: fixed"]');
    modals.forEach(m => {
      if (m.innerHTML.includes('ì„ì‹œì €ì¥ëœ ì¶œê²° ëª©ë¡')) {
        m.remove();
      }
    });
    
    if (hasTempData) {
      showTempDataList();
    } else {
      alert("ëª¨ë“  ì„ì‹œì €ì¥ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  }
}

// ì„ì‹œì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateTempSaveButton() {
  const btn = document.querySelector('button[onclick="tempSaveAttendance()"]');
  if (!btn) return;
  
  const classroom = getCurrentClassroom();
  const timeSlot = currentTimeSlot;
  const date = getCurrentDate();
  const tempKey = `${date}_${classroom}_${timeSlot}`;
  
  if (tempSavedData[tempKey]) {
    btn.style.background = "#FF5722";
    btn.innerHTML = `ğŸ“‹ ì„ì‹œì €ì¥ë¨ (${tempSavedData[tempKey].savedAt})`;
  } else {
    btn.style.background = "#FF9800";
    btn.innerHTML = "ğŸ“‹ ì„ì‹œì €ì¥";
  }
}
function handleSeatClick(btn) {
  if (btn.disabled) return;

  const cur = btn.dataset.status;
  const seatId = btn.dataset.seatId;
  const classroom = getCurrentClassroom();
  
  // í™”ë©´ ì—…ë°ì´íŠ¸
  if (cur === "ë¯¸ì²´í¬") {
    btn.dataset.status = "ì¶œì„";
    btn.querySelector(".seatStatus").innerText = "[ì¶œì„]";
    btn.style.backgroundColor = "#a5d8ff";
  } else if (cur === "ì¶œì„") {
    btn.dataset.status = "ê²°ì„";
    btn.querySelector(".seatStatus").innerText = "[ê²°ì„]";
    btn.style.backgroundColor = "#ccc";
  } else if (cur === "ê²°ì„") {
    btn.dataset.status = "ì¶œì„";
    btn.querySelector(".seatStatus").innerText = "[ì¶œì„]";
    btn.style.backgroundColor = "#a5d8ff";
  }
  
  // ìºì‹œ ì—…ë°ì´íŠ¸ë§Œ
  if (!allClassroomStatus[classroom][currentTimeSlot]) {
    allClassroomStatus[classroom][currentTimeSlot] = {};
  }
  allClassroomStatus[classroom][currentTimeSlot][seatId] = {
    status: btn.dataset.status
  };
  
  // autoSaveTempData(); â† ì œê±°
  
  isSaved = false;
}


function openClassroom(name) {
  // ë°ì´í„° ë¡œë“œê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê²½ê³  í›„ ì§„í–‰
  if (Object.keys(studentMap).length === 0) {
    console.warn("í•™ìƒ ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ì‹œë„...");
    // í•™ìƒ ë°ì´í„° ê°•ì œ ë¡œë“œ í›„ êµì‹¤ ì—´ê¸°
    google.script.run
      .withSuccessHandler(data => {
        studentMap = data || {};
        console.log("í•™ìƒ ë°ì´í„° ê¸´ê¸‰ ë¡œë“œ ì™„ë£Œ");
        openClassroomInternal(name);
      })
      .withFailureHandler(err => {
        console.error("í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
        alert("í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
      })
      .getStudentMap();
    return;
  }

  openClassroomInternal(name);
}

function openClassroomInternal(name) {
  if (!isSaved) {
    if (!confirm("ì•„ì§ ì¶œê²°ì„ ì €ì¥í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ êµì‹¤ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  }

  // ì‹œê°„ëŒ€ ì§ì ‘ ê³„ì‚°
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const currentTime = hours * 60 + minutes;

  if (currentTime >= 0 && currentTime < 3 * 60) {
    currentTimeSlot = "EP2";
  } else if (currentTime >= 21 * 60) {
    currentTimeSlot = "EP2";
  } else if (currentTime >= 19 * 60 + 10) {
    currentTimeSlot = "EP1";
  } else if (currentTime >= 16 * 60 + 40) {
    currentTimeSlot = "ET";
  } else {
    currentTimeSlot = "ET";
  }
  
  document.querySelectorAll(".time-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.slot === currentTimeSlot);
  });

  isSaved = true;
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("classroomView").style.display = "block";
  document.getElementById("statsView").style.display = "none";
  document.getElementById("statsTable").innerHTML = "";

  const headerButtons = document.getElementById("headerAttendanceButtons");
  if (headerButtons) {
    headerButtons.style.display = "inline-flex";
  }

  document.getElementById("classroomTitle").innerText = name + " êµì‹¤";

  // ì¢Œì„ ê·¸ë¦¬ê¸°
  const drawFns = {
    '4A': draw4ASeats,
    '4B': draw4BSeats,
    '4C': draw4CSeats,
    '4D': draw4DSeats,
    'C407': drawC407Seats,
    'C409': drawC409Seats,
    'A401': () => drawDynamicClassroom("A401", 6, 5),
    'A402': () => drawDynamicClassroom("A402", 6, 5),
    'A408': () => drawDynamicClassroom("A408", 6, 5)
  };

  const fn = drawFns[name];
  if (fn) fn();

  // ì„ì‹œì €ì¥ ë°ì´í„° ìš°ì„  í™•ì¸ ë° ì ìš©
  const date = getCurrentDate();
  const tempKey = `${date}_${name}_${currentTimeSlot}`;
  
  if (tempSavedData[tempKey] && tempSavedData[tempKey].status) {
    console.log(`êµì‹¤ ì§„ì… - ì„ì‹œì €ì¥ ë°ì´í„° ì ìš©: ${name} ${currentTimeSlot}`);
    
    Object.keys(tempSavedData[tempKey].status).forEach(seatId => {
      const btn = document.querySelector(`button[data-seat-id="${seatId}"]`);
      if (btn && !btn.disabled) {
        const status = tempSavedData[tempKey].status[seatId];
        btn.dataset.status = status;
        btn.querySelector(".seatStatus").innerText = `[${status}]`;
        btn.style.backgroundColor = status === "ì¶œì„" ? "#a5d8ff" : "#ccc";
        
        // ìºì‹œì—ë„ ë™ê¸°í™”
        if (!allClassroomStatus[name]) {
          allClassroomStatus[name] = { ET: {}, EP1: {}, EP2: {} };
        }
        if (!allClassroomStatus[name][currentTimeSlot]) {
          allClassroomStatus[name][currentTimeSlot] = {};
        }
        allClassroomStatus[name][currentTimeSlot][seatId] = { status: status };
      }
    });
  } else if (allClassroomStatus[name] && 
             allClassroomStatus[name][currentTimeSlot] &&
             Object.keys(allClassroomStatus[name][currentTimeSlot]).length > 0) {
    console.log(`êµì‹¤ ì§„ì… - ìºì‹œ ë°ì´í„° ì ìš©: ${name} ${currentTimeSlot}`);
    applySeatStatus(allClassroomStatus[name][currentTimeSlot]);
  }
  
  updateSleepPostItDisplay();
  updateTempSaveButton();
  
  // ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
  const today = getCurrentDate();
  google.script.run
    .withSuccessHandler(statusMap => {
      console.log(`ì„œë²„ ë™ê¸°í™” ì™„ë£Œ: ${name} ${currentTimeSlot}`, statusMap);
      allClassroomStatus[name][currentTimeSlot] = statusMap || {};
      
      if (getCurrentClassroom() === name && 
          document.querySelectorAll(".time-btn.active")[0]?.dataset.slot === currentTimeSlot) {
        applySeatStatus(statusMap);
      }
    })
    .withFailureHandler(() => {
      console.log(`${name} ${currentTimeSlot} ë™ê¸°í™” ì‹¤íŒ¨ - ì„ì‹œì €ì¥/ìºì‹œ ë°ì´í„° ì‚¬ìš©`);
    })
    .getSeatStatusMap(today, currentTimeSlot, name);
}
    function drawDynamicClassroom(prefix, cols, rows) {
      const grid = document.getElementById("seatGrid");
      grid.innerHTML = "";

      // ì „ì²´ ì¢Œì„ ë°°ì—´ì„ ë¯¸ë¦¬ ìƒì„±
      const seats = [];
      let num = 1;
      for (let r = 0; r < rows; r++) {
        seats.push([]);
        for (let c = 0; c < cols; c++) {
          seats[r][c] = prefix + "-" + String(num).padStart(3, "0");
          num++;
        }
      }

      // ì„¸ë¡œ ê¸°ì¤€ìœ¼ë¡œ ì¢Œì„ ì¬êµ¬ì„±
      for (let c = 0; c < cols; c++) {
        const rowDiv = document.createElement("div");
        rowDiv.className = "seat-row";
        for (let r = 0; r < rows; r++) {
          const seatId = seats[r][c];
          const btn = createSeatButton(seatId);
          rowDiv.appendChild(btn);
        }
        grid.appendChild(rowDiv);
      }
    }

    // ê° êµì‹¤ë³„ ë ˆì´ì•„ì›ƒ í•¨ìˆ˜
    function draw4ASeats() {
      const layout = [
        ["4A146", "4A145", "4A144", "4A143", "4A142", "sp", "4A141", "4A140", "4A139", "4A138", "4A137"],
        ["br"],
        ["4A136", "4A135", "4A134", "4A133", "4A132", "sp", "4A131", "4A130", "4A129", "4A128", "4A127", "4A126"],
        ["4A125", "4A124", "4A123", "4A122", "4A121", "sp", "4A120", "4A119", "4A118", "4A117", "4A116", "4A115"],
        ["br"],
        ["4A114", "4A113", "4A112", "4A111", "4A110", "sp", "4A109", "4A108", "4A107", "4A106", "4A105", "4A104"],
        ["4A103", "4A102", "4A101", "4A100", "4A099", "sp", "4A098", "4A097", "4A096", "4A095", "4A094", "4A093"],
        ["br"],
        ["4A092", "4A091", "4A090", "4A089", "4A088", "sp", "4A087", "4A086", "4A085", "4A084"],
        ["4A083", "4A082", "4A081", "4A080", "4A079", "sp", "4A078", "4A077", "4A076", "4A075"],
        ["br"],
        ["4A074", "4A073", "4A072", "4A071", "4A070", "sp", "4A069", "4A068", "4A067", "4A066", "4A065", "4A064"],
        ["4A063", "4A062", "4A061", "4A060", "4A059", "sp", "4A058", "4A057", "4A056", "4A055", "4A054", "4A053"],
        ["br"],
        ["4A052", "4A051", "4A050", "4A049", "4A048", "sp", "4A047", "4A046", "4A045", "4A044", "4A043", "4A042"],
        ["4A041", "4A040", "4A039", "4A038", "4A037", "sp", "4A036", "4A035", "4A034", "4A033", "4A032", "4A031"],
        ["br"],
        ["4A030", "4A029", "4A028", "4A027", "4A026", "sp", "4A025", "4A024", "4A023", "4A022", "4A021"],
        ["4A020", "4A019", "4A018", "4A017", "4A016", "sp", "4A015", "4A014", "4A013", "4A012", "4A011"],
        ["br"],
        ["4A010", "4A009", "4A008", "4A007", "4A006", "sp", "4A005", "4A004", "4A003", "4A002", "4A001"]
      ];
      renderSeatLayout(layout);
    }

    function draw4BSeats() {
      const layout = [
        ["4B061", "4B060", "4B059", "4B058", "4B057", "sp", "4B056", "4B055", "4B054", "4B053", "4B052", "sp", "4B051", "4B050", "4B049"],
        ["4B048", "4B047", "4B046", "4B045", "4B044", "sp", "4B043", "4B042", "4B041", "4B040", "4B039", "sp", "4B038", "4B037", "4B036"],
        ["br"],
        ["4B035", "4B034", "4B033", "4B032", "4B031", "sp", "4B030", "4B029", "4B028", "4B027", "4B026", "sp", "4B025", "4B024", "4B023"],
        ["4B022", "4B021", "4B020", "4B019", "4B018", "sp", "4B017", "4B016", "4B015", "4B014", "4B013", "sp", "4B012", "4B011", "4B010"],
        ["br"],
        ["4B009", "4B008", "4B007", "4B006", "4B005", "sp", "empty", "4B004", "4B003", "4B002", "4B001"]
      ];
      renderSeatLayout(layout);
    }

    function draw4CSeats() {
      const layout = [
        ["4C053", "4C052", "4C051", "4C050", "4C049", "4C048", "4C047", "sp", "4C046", "4C045", "4C044", "4C043", "4C042"],
        ["4C041", "4C040", "4C039", "4C038", "4C037", "4C036", "4C035", "sp", "4C034", "4C033", "4C032", "4C031", "4C030"],
        ["br"],
        ["4C029", "4C028", "4C027", "4C026", "4C025", "4C024", "4C023", "sp", "4C022", "4C021", "4C020", "4C019", "4C018"],
        ["4C017", "4C016", "4C015", "4C014", "4C013", "4C012", "4C011", "sp", "4C010", "4C009", "4C008", "4C007", "4C006"],
        ["br"],
        ["empty", "empty", "4C005", "4C004", "4C003", "empty", "empty", "sp", "empty", "empty","empty", "4C002", "4C001"]
      ];
      renderSeatLayout(layout);
    }

    function draw4DSeats() {
      const layout = [
        ["4D120", "4D119", "4D118", "4D117", "4D116", "4D115", "sp", "4D114", "4D113", "4D112", "4D111", "4D110"],
        ["4D109", "4D108", "4D107", "4D106", "4D105", "4D104", "sp", "4D103", "4D102", "4D101", "4D100", "4D099"],
        ["br"],
        ["4D098", "4D097", "4D096", "4D095", "4D094", "4D093", "sp", "4D092", "4D091", "4D090", "4D089", "4D088"],
        ["4D087", "4D086", "4D085", "4D084", "4D083", "4D082", "sp", "4D081", "empty", "empty", "4D080", "4D079"],
        ["br"],
        ["4D078", "4D077", "4D076", "4D075", "4D074", "4D073", "sp", "4D072", "4D071", "4D070", "4D069", "4D068"],
        ["4D067", "4D066", "4D065", "4D064", "4D063", "4D062", "sp", "4D061", "4D060", "4D059", "4D058", "4D057"],
        ["br"],
        ["4D056", "4D055", "4D054", "4D053", "4D052", "4D051", "sp", "4D050", "4D049", "4D048", "4D047", "4D046"],
        ["4D045", "4D044", "4D043", "4D042", "4D041", "4D040", "sp", "4D039", "4D038", "4D037", "4D036", "4D035"],
        ["br"],
        ["4D034", "4D033", "4D032", "4D031", "4D030", "4D029", "sp", "4D028", "empty", "empty", "4D027", "4D026"],
        ["4D025", "4D024", "4D023", "4D022", "4D021", "4D020", "sp", "4D019", "4D018", "4D017", "4D016", "4D015"],
        ["br"],
        ["empty", "empty", "4D014", "4D013", "4D012", "4D011", "sp", "4D010", "4D009", "4D008", "4D007", "4D006"],
        ["empty", "empty", "empty", "empty", "empty", "empty", "sp", "4D005", "4D004", "4D003", "4D002", "4D001"]
      ];
      renderSeatLayout(layout);
    }

function drawC407Seats() {
  const layout = [
    ["C407-001", "C407-007", "C407-013", "C407-019", "C407-025"],
    ["br"],
    ["C407-002", "C407-008", "C407-014", "C407-020", "C407-026"],
    ["br"],
    ["C407-003", "C407-009", "C407-015", "C407-021", "C407-027"],
    ["br"],
    ["C407-004", "C407-010", "C407-016", "C407-022", "C407-028"],
    ["br"],
    ["C407-005", "C407-011", "C407-017", "C407-023", "C407-029"],
    ["br"],
    ["C407-006", "C407-012", "C407-018", "C407-024", "C407-030"]
  ];
  renderSeatLayout(layout);
}

function drawC409Seats() {
  const layout = [
    ["C409-001", "C409-007", "C409-013", "C409-019", "C409-025","C409-031"],
    ["br"],
    ["C409-002", "C409-008", "C409-014", "C409-020", "C409-026","C409-032"],
    ["br"],
    ["C409-003", "C409-009", "C409-015", "C409-021", "C409-027","C409-033"],
    ["br"],
    ["C409-004", "C409-010", "C409-016", "C409-022", "C409-028","C409-034"],
    ["br"],
    ["C409-005", "C409-011", "C409-017", "C409-023", "C409-029","C409-035"],
    ["br"],
    ["C409-006", "C409-012", "C409-018", "C409-024", "C409-030","C409-036"]
  ];
  renderSeatLayout(layout);
}

function createSeatButton(seatId) {
  const btn = document.createElement("button");
  btn.className = "seat";
  btn.dataset.seatId = seatId;

  const student = studentMap[seatId];
  const name = student?.name?.trim() || "";

  btn.dataset.status = "ë¯¸ì²´í¬";
  btn.style.backgroundColor = "#fff3cd";
  btn.disabled = false;
  btn.style.opacity = 1;
  btn.style.cursor = "pointer";

  if (!name) {
    btn.dataset.status = "ë¯¸ë°°ì •";
    btn.disabled = true;
    btn.style.opacity = 0.4;
    btn.style.cursor = "not-allowed";
  }

  // ë°œì „ì‹¤ ì´ë™ í•™ìƒ ì²˜ë¦¬ (ì¢Œì„ ìƒì„± ì‹œì ì— ë°”ë¡œ ì ìš©)
  if (student) {
    const moveDateStr = student.moveDate || "";
    const movedSeat = student.movedSeat || "";
    const currentDateStr = getCurrentDate();
    const currentClassroom = getCurrentClassroom();
    const isDevRoom = ["A401", "A402", "A408"].includes(currentClassroom);

    // ì¼ë°˜ êµì‹¤ì—ì„œ ë°œì „ì‹¤ ì´ë™ ì™„ë£Œì í‘œì‹œ
    if (!isDevRoom && moveDateStr && currentDateStr >= moveDateStr && movedSeat) {
      btn.dataset.status = "ë°œì „ì‹¤";
      btn.style.backgroundColor = "#ff9999";
      btn.disabled = true;
      btn.style.opacity = 0.4;
      btn.style.cursor = "not-allowed";
    }
    // ë°œì „ì‹¤ì—ì„œ ì†Œëª…ì¤‘ì¸ í•™ìƒ í‘œì‹œ
    else if (isDevRoom && moveDateStr && currentDateStr < moveDateStr && movedSeat) {
      btn.dataset.status = "ì†Œëª…ì¤‘";
      btn.style.backgroundColor = "#eee";
      btn.disabled = true;
      btn.style.opacity = 0.4;
      btn.style.cursor = "not-allowed";
    }
  }

  // í…Œë‘ë¦¬ í‘œì‹œ: ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡, ì‚¬ì „ ê²°ì„, ë‘˜ ë‹¤
  if (student) {
    const hasSleepPostIt = sleepPostItStudents[student.studentId];
    const absenceSheet = currentTimeSlot === "ET" ? "ET" : "EP1";
    const hasPreAbsence = preAbsenceData[absenceSheet] && preAbsenceData[absenceSheet][student.studentId];

    if (hasSleepPostIt && hasPreAbsence) {
      btn.classList.add('sleep-and-absence');
    } else if (hasSleepPostIt) {
      btn.classList.add('sleep-postit');
    } else if (hasPreAbsence) {
      btn.classList.add('pre-absence');
    }
  }

  btn.innerHTML = `
    <span class="seatId">${seatId}</span>
    <span class="studentName">${name}</span>
    <span class="seatStatus">[${btn.dataset.status}]</span>
  `;

  // í„°ì¹˜/í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
  let pressTimer = null;
  let isLongPress = false;
  let touchStartTime = 0;

  const handleTap = () => {
    if (!isLongPress && !btn.disabled) {
      handleSeatClick(btn);
    }
    isLongPress = false;
  };

// createSeatButton í•¨ìˆ˜ì˜ startLongPress ë¶€ë¶„ì„ ìˆ˜ì •

const startLongPress = () => {
  isLongPress = false;
  touchStartTime = Date.now();

  pressTimer = setTimeout(() => {
    isLongPress = true;
    currentSeatId = seatId;

    // ì‚¬ì „ ê²°ì„ ì •ë³´ í™•ì¸
    const absenceSheet = currentTimeSlot === "ET" ? "ET" : "EP1";
    const preAbsence = student && preAbsenceData[absenceSheet] && preAbsenceData[absenceSheet][student.studentId];

    let studentInfo = student
      ? `ì´ë¦„: ${student.name}<br>í•™ë²ˆ: ${student.studentId}<br>HR: ${student.hr}`
      : "í•™ìƒ ì •ë³´ ì—†ìŒ";

    // ì‚¬ì „ ê²°ì„ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€ í‘œì‹œ
    if (preAbsence) {
      studentInfo += `<br><div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <strong style="color: #856404;">ğŸ“‹ ì‚¬ì „ ê²°ì„ ì •ë³´</strong><br>
        <span style="color: #856404;">ì‚¬ìœ : ${preAbsence.reason || "ë¯¸ì…ë ¥"}</span><br>
        <span style="color: #856404;">ë¹„ê³ : ${preAbsence.note || "ì—†ìŒ"}</span>
      </div>`;
    }

    document.getElementById("studentInfoText").innerHTML = studentInfo;

    // í˜„ì¬ êµì‹¤ í™•ì¸
    const currentClassroom = getCurrentClassroom();
    const isSpecialRoom = ["C407", "C409", "A401", "A402", "A408"].includes(currentClassroom);

    // ìœ„ë°˜ì‚¬í•­ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById("violationType").value = "";
    document.getElementById("violationNote").value = "";

    // ëª¨ë‹¬ í‘œì‹œ
    document.getElementById("infoModal").style.display = "flex";
    
    // ìŠ¤í¬ë¡¤ ì´ˆê¸°í™”
    const modalContent = document.querySelector("#infoModal .modal-content");
    if (modalContent) {
      modalContent.scrollTop = 0;
    }

    // íŠ¹ìˆ˜ êµì‹¤ ì²˜ë¦¬
    if (isSpecialRoom) {
      // ìˆ˜ë©´ í¬ìŠ¤íŠ¸ì‡ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      const sleepBtn = document.getElementById("sleepPostItBtn");
      if (sleepBtn) {
        sleepBtn.style.display = "none";
      }
      
      // ìœ„ë°˜ì‚¬í•­ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.getElementById("violationTypeLabel").style.display = "none";
      document.querySelector('label:has(#violationNote)').style.display = "none";
      document.getElementById("todayViolations").style.display = "none";
      
      // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      const modalButtons = document.querySelector("#infoModal .modal-buttons");
      const saveBtn = modalButtons.querySelector('button[onclick="saveViolation()"]');
      if (saveBtn) {
        saveBtn.style.display = "none";
      }
      
      // íŠ¹ìˆ˜ êµì‹¤ ë©”ì‹œì§€ í‘œì‹œ
      showSpecialRoomMessage(currentClassroom);
    } else {
      // ì¼ë°˜ êµì‹¤ì¸ ê²½ìš°
      const sleepBtn = document.getElementById("sleepPostItBtn");
      if (sleepBtn) {
        sleepBtn.style.display = "block";
        updateSleepPostItButton(student);
      }
      
      document.getElementById("violationTypeLabel").style.display = "block";
      document.querySelector('label:has(#violationNote)').style.display = "block";
      
      const modalButtons = document.querySelector("#infoModal .modal-buttons");
      const saveBtn = modalButtons.querySelector('button[onclick="saveViolation()"]');
      if (saveBtn) {
        saveBtn.style.display = "inline-block";
      }
      
      // íŠ¹ìˆ˜ êµì‹¤ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
      const specialMsg = document.getElementById("specialRoomMessage");
      if (specialMsg) {
        specialMsg.style.display = "none";
      }
    }

    // ëª¨ë“  êµì‹¤ì—ì„œ ì˜¤ëŠ˜ ìœ„ë°˜ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° (íŠ¹ìˆ˜ êµì‹¤ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´)
    if (student && student.studentId) {
      // setTimeoutìœ¼ë¡œ DOM ë Œë”ë§ ì™„ë£Œ í›„ ì‹¤í–‰
      setTimeout(() => {
        loadTodayViolations(student.studentId);
      }, 100);
    }
    
  }, 800);
};
  const cancelLongPress = () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
    }
    
    const pressDuration = Date.now() - touchStartTime;
    if (pressDuration < 800 && !isLongPress) {
      handleTap();
    }
  };

  // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸
  btn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    startLongPress();
  }, { passive: false });

  btn.addEventListener('touchend', (e) => {
    e.preventDefault();
    cancelLongPress();
  }, { passive: false });

  btn.addEventListener('touchcancel', () => {
    cancelLongPress();
  }, { passive: false });

  // ë°ìŠ¤í¬í†± ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
  btn.addEventListener('mousedown', (e) => {
    e.preventDefault();
    startLongPress();
  });

  btn.addEventListener('mouseup', (e) => {
    e.preventDefault();
    cancelLongPress();
  });

  btn.addEventListener('mouseleave', () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
    }
  });

  // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë°©ì§€
  btn.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    return false;
  });

  return btn;
}
    
function showSpecialRoomMessage(classroom) {
  // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
  let messageDiv = document.getElementById("specialRoomMessage");
  if (!messageDiv) {
    // ë©”ì‹œì§€ div ìƒì„±
    messageDiv = document.createElement("div");
    messageDiv.id = "specialRoomMessage";
    
    // í•™ìƒ ì •ë³´ ë‹¤ìŒì— ì‚½ì…
    const studentInfoText = document.getElementById("studentInfoText");
    studentInfoText.parentNode.insertBefore(messageDiv, studentInfoText.nextSibling.nextSibling);
  }
  
  // ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì„¤ì •
  messageDiv.style.cssText = `
    margin: 20px 0;
    padding: 15px;
    background: #e3f2fd;
    border: 2px solid #1976d2;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    color: #0d47a1;
    font-size: 1.1em;
  `;
  
  // êµì‹¤ë³„ ë©”ì‹œì§€ ì„¤ì •
  if (classroom === "C407" || classroom === "C409") {
    messageDiv.innerHTML = `
      <div>ğŸ“š ê°•ì˜ì‹¤ ë©´í•™ìëŠ” ë°œì „ì‹¤ ì´ë™ ëŒ€ìƒìê°€ ì•„ë‹ˆë‹ˆ</div>
      <div style="margin-top: 5px;">ì „ìê¸°ê¸° ê´€ì°°ìª½ì§€ë§Œ ë¶€ì—¬í•´ì£¼ì„¸ìš”</div>
    `;
  } else if (classroom === "A401" || classroom === "A402" || classroom === "A408") {
    messageDiv.innerHTML = `
      <div>ğŸ¢ ë°œì „ì‹¤ ë©´í•™ìëŠ”</div>
      <div style="margin-top: 5px;">ì „ìê¸°ê¸° ì‚¬ìš©ì‹œ ê´€ì°°ìª½ì§€ë§Œ ë¶€ì—¬í•´ì£¼ì„¸ìš”</div>
    `;
  }
  
  messageDiv.style.display = "block";
}
    
function saveAttendanceForClassroom() {
  if (isSaving) {
    alert("ì´ë¯¸ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
    return;
  }

  const classroom = getCurrentClassroom();
  const date = getCurrentDate();  
  const timeSlot = currentTimeSlot;

  const entries = [];
  let hasUnchecked = false;
  const tempStatusMap = {};

  document.querySelectorAll(".seat").forEach(btn => {
    const seatId = btn.dataset.seatId;
    const status = btn.dataset.status;
    const student = studentMap[seatId];

    if (!student || !status || ["ë°œì „ì‹¤", "ì†Œëª…ì¤‘", "ë¯¸ë°°ì •"].includes(status)) return;

    if (status === "ë¯¸ì²´í¬") hasUnchecked = true;

    entries.push({
      seatNumber: seatId,
      studentId: student.studentId,
      name: student.name,
      classroom: classroom,
      timeSlot: timeSlot,
      status: status
    });
    
    if (status === "ì¶œì„" || status === "ê²°ì„") {
      tempStatusMap[seatId] = { status: status };
    }
  });

  if (hasUnchecked) {
    alert("â— ë¯¸ì²´í¬ ìƒíƒœì¸ í•™ìƒì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  í•™ìƒì˜ ì¶œê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    return;
  }

  isSaving = true;
  const saveButton = document.querySelector('button[onclick="saveAttendanceForClassroom()"]');
  if (saveButton) {
    saveButton.disabled = true;
    saveButton.style.opacity = "0.5";
    saveButton.textContent = "ğŸ’¾ ì €ì¥ ì¤‘...";
  }

  const handleError = (err, context) => {
    console.error(`[${context}] ì˜¤ë¥˜ ë°œìƒ:`, err);
    
    let errorMsg = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    let errorDetail = "";
    let errorType = "UNKNOWN";
    
    if (err && typeof err === 'object') {
      if (err.message) {
        errorMsg = err.message;
        errorDetail = `message: ${err.message}`;
      } else if (err.error) {
        errorMsg = err.error;
        errorDetail = `error: ${err.error}`;
      }
    } else if (typeof err === 'string') {
      errorMsg = err;
      errorDetail = `string: ${err}`;
    }
    
    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ê°ì§€ (í‚¤ì›Œë“œ ê¸°ë°˜)
    const networkKeywords = ['network', 'timeout', 'Failed', 'Connection', 'unreachable'];
    if (networkKeywords.some(k => errorMsg.toLowerCase().includes(k.toLowerCase()))) {
      errorType = "NETWORK";
      errorMsg = "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.\n\nWi-Fië¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    }
    
    // ê¶Œí•œ/ì¸ì¦ ì˜¤ë¥˜ ê°ì§€
    const authKeywords = ['authorization', 'permission', 'access denied', 'unauthorized', 'forbidden'];
    if (authKeywords.some(k => errorMsg.toLowerCase().includes(k.toLowerCase()))) {
      errorType = "AUTH";
      errorMsg = "ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
    }
    
    // undefined ë˜ëŠ” ë¹ˆ ë©”ì‹œì§€ = ë„¤íŠ¸ì›Œí¬/ì„¸ì…˜ ë¬¸ì œ ê°€ëŠ¥ì„± ë†’ìŒ
    if (!errorMsg || errorMsg === "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.") {
      errorType = "NETWORK_OR_SESSION";
      errorMsg = "ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n1. Wi-Fi ì—°ê²° ìƒíƒœ\n2. êµ¬ê¸€ ê³„ì • ë¡œê·¸ì¸ ìƒíƒœ\n3. ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨";
    }
    
    alert(`âŒ ${context} ì‹¤íŒ¨\n\n${errorMsg}\n\nì˜¤ë¥˜ ìœ í˜•: ${errorType}\nì‹œê°: ${new Date().toLocaleString('ko-KR')}\n\nìƒì„¸: ${errorDetail}`);
    resetSaveButton();
  };

  google.script.run
    .withSuccessHandler(existingData => {
      console.log("[ê¸°ì¡´ ë°ì´í„° í™•ì¸] ì„±ê³µ:", existingData);
      
      if (existingData && Object.keys(existingData).length > 0) {
        const message = `âš ï¸ ${date} ${classroom} êµì‹¤ ${timeSlot} ì‹œê°„ëŒ€ì˜ ì¶œê²° ì •ë³´ê°€ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`;
        if (!confirm(message)) {
          alert("ë®ì–´ì“°ê¸°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          resetSaveButton();
          return;
        }
      }
      
      const estimatedTimeSec = 3;
      const confirmSave = confirm(`ğŸ’¾ ì €ì¥ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ 'í™•ì¸'ì„ ëˆŒëŸ¬ì•¼ ì €ì¥ì´ ì‹œì‘ë©ë‹ˆë‹¤.\n\nì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ ${estimatedTimeSec}ì´ˆ\nì™„ë£Œ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);

      if (!confirmSave) {
        resetSaveButton();
        return;
      }

      alert(`â³ ì €ì¥ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\nì™„ë£Œ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ${estimatedTimeSec}ì´ˆ ì •ë„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.\nì´ ì°½ì„ ë‹«ì•„ë„ ì €ì¥ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.`);

      console.log("[ì¶œê²° ì €ì¥] ì‹œì‘:", { date, classroom, timeSlot, entries: entries.length });

      google.script.run
        .withSuccessHandler(() => {
          console.log("[ì¶œê²° ì €ì¥] ì„±ê³µ");
          allClassroomStatus[classroom][timeSlot] = tempStatusMap;
          
          // ì„ì‹œì €ì¥ ë°ì´í„° ì‚­ì œ
          const tempKey = `${date}_${classroom}_${timeSlot}`;
          if (tempSavedData[tempKey]) {
            delete tempSavedData[tempKey];
            localStorage.setItem('tempAttendanceData', JSON.stringify(tempSavedData));
            hasTempData = Object.keys(tempSavedData).length > 0;
          }
          
          alert("âœ… ì¶œê²°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          isSaved = true;
          resetSaveButton();
          updateTempSaveButton(); // ì„ì‹œì €ì¥ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        })
        .withFailureHandler(err => handleError(err, "ì¶œê²° ì €ì¥"))
        .saveAttendanceBulk(entries);
    })
    .withFailureHandler(err => {
      handleError(err, "ê¸°ì¡´ ë°ì´í„° í™•ì¸");
      
      // ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨í•´ë„ ì €ì¥ì€ ì§„í–‰í•˜ë„ë¡ í•˜ëŠ” ì˜µì…˜
      const proceedAnyway = confirm("ê¸°ì¡´ ë°ì´í„° í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nê·¸ë˜ë„ ì €ì¥ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (!proceedAnyway) {
        resetSaveButton();
        return;
      }
      
      const estimatedTimeSec = 3;
      alert(`â³ ì €ì¥ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\nì™„ë£Œ ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ${estimatedTimeSec}ì´ˆ ì •ë„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`);

      console.log("[ì¶œê²° ì €ì¥] ì‹œì‘ (ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨ í›„):", { date, classroom, timeSlot, entries: entries.length });

      google.script.run
        .withSuccessHandler(() => {
          console.log("[ì¶œê²° ì €ì¥] ì„±ê³µ");
          allClassroomStatus[classroom][timeSlot] = tempStatusMap;
          
          // ì„ì‹œì €ì¥ ë°ì´í„° ì‚­ì œ
          const tempKey = `${date}_${classroom}_${timeSlot}`;
          if (tempSavedData[tempKey]) {
            delete tempSavedData[tempKey];
            localStorage.setItem('tempAttendanceData', JSON.stringify(tempSavedData));
            hasTempData = Object.keys(tempSavedData).length > 0;
          }
          
          alert("âœ… ì¶œê²°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          isSaved = true;
          resetSaveButton();
          updateTempSaveButton(); // ì„ì‹œì €ì¥ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        })
        .withFailureHandler(err => handleError(err, "ì¶œê²° ì €ì¥"))
        .saveAttendanceBulk(entries);
    })
    .getSeatStatusMap(date, timeSlot, classroom);
}

// ì €ì¥ ë²„íŠ¼ ìƒíƒœ ë³µêµ¬ í•¨ìˆ˜
function resetSaveButton() {
  isSaving = false;
  const saveButton = document.querySelector('button[onclick="saveAttendanceForClassroom()"]');
  if (saveButton) {
    saveButton.disabled = false;
    saveButton.style.opacity = "1";
    saveButton.textContent = "ğŸ’¾ ì¶œê²° ì €ì¥";
  }
}
function resolveSeatDisplayStatus(seatId, currentStatus) {
  const student = studentMap[seatId];
  const name = student?.name?.trim() || "";
  const moveDateStr = student?.moveDate || "";
  const movedSeat = student?.movedSeat || "";
  const currentDateStr = getCurrentDate();
  const currentClassroom = getCurrentClassroom();

  const isDevRoom = ["A401", "A402", "A408"].includes(currentClassroom);
  const isMovedToDevRoom = moveDateStr && currentDateStr >= moveDateStr;
  const isBeforeMove = moveDateStr && currentDateStr < moveDateStr;

  if (!name) {
    return { status: "ë¯¸ë°°ì •", color: "#eee", disabled: true, title: "í•™ìƒ ë¯¸ë°°ì •" };
  }

  // ì´ë™ ì˜ˆì •ì ì²˜ë¦¬
  if (isBeforeMove && movedSeat) {
    // ë°œì „ì‹¤ì—ì„œëŠ” ë¹„í™œì„±í™”
    if (isDevRoom) {
      return {
        status: "ì†Œëª…ì¤‘",
        color: "#eee",
        disabled: true,
        title: "ì†Œëª…ì¤‘ - ë°œì „ì‹¤ ì´ë™ ì˜ˆì •"
      };
    }
    // ì¼ë°˜ êµì‹¤ì—ì„œëŠ” ì†Œëª…ì¤‘ í‘œì‹œí•˜ì§€ë§Œ í™œì„±í™”
    return {
      status: currentStatus || "ë¯¸ì²´í¬",
      color: currentStatus === "ì¶œì„" ? "#a5d8ff" : currentStatus === "ê²°ì„" ? "#ccc" : "#fff3cd",
      disabled: false,
      title: "ì†Œëª…ì¤‘ - ë°œì „ì‹¤ ì´ë™ ì˜ˆì •"
    };
  }

  // ë°œì „ì‹¤ ì´ë™ ì™„ë£Œì â†’ ë°œì „ì‹¤
  if (!isDevRoom && isMovedToDevRoom) {
    return {
      status: "ë°œì „ì‹¤",
      color: "#ff9999",
      disabled: true,
      title: "ë°œì „ì‹¤ ì´ë™ì"
    };
  }

  // ì¼ë°˜ ìƒíƒœ ì²˜ë¦¬
  if (currentStatus === "ì¶œì„") return { status: "ì¶œì„", color: "#a5d8ff", disabled: false };
  if (currentStatus === "ê²°ì„") return { status: "ê²°ì„", color: "#ccc", disabled: false };
  if (currentStatus === "ë°œì „ì‹¤") return { status: "ë°œì „ì‹¤", color: "#ff9999", disabled: true };
  if (currentStatus === "ì†Œëª…ì¤‘") return { status: "ì†Œëª…ì¤‘", color: "#eee", disabled: true };

  return { status: "ë¯¸ì²´í¬", color: "#fff3cd", disabled: false };
}

document.addEventListener('DOMContentLoaded', function() {
  // ì „ì²´ ë°ì´í„° ë¡œë“œ ì‹œì‘ (showGuideViewëŠ” loadAllDataAtStart ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
  loadAllDataAtStart();
  
  // ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì¶”ê°€
  loadTempSavedData();
  
  // ëª¨ë‹¬ í„°ì¹˜ ì´ë²¤íŠ¸ ë“±ë¡
  const modalContent = document.querySelector("#infoModal .modal-content");
  if (modalContent) {
    modalContent.addEventListener('touchstart', function(e) {
      this.startY = e.touches[0].pageY;
    }, { passive: true });

    modalContent.addEventListener('touchmove', function(e) {
      e.stopPropagation();
    }, { passive: true });
  }
});

// Pull-to-refresh ë°©ì§€

// í„°ì¹˜ ì‹œì‘
document.addEventListener('touchstart', function(e) {
  touchStartY = e.touches[0].clientY;
  warningShown = false;
}, { passive: false });


document.addEventListener('touchmove', function(e) {
  const touchY = e.touches[0].clientY;
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
  
  // ìµœìƒë‹¨ì—ì„œ ì•„ë˜ë¡œ ë‹¹ê¸°ëŠ” ë™ì‘ ê°ì§€
  if (scrollTop === 0) {
    pullDistance = touchY - touchStartY;
    
    // 50í”½ì…€ ì´ìƒ ë‹¹ê¸°ë©´ ê²½ê³  (í•œ ë²ˆë§Œ)
    if (pullDistance > 50 && !warningShown) {
      warningShown = true;
      
      // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
      showRefreshWarning();
      
      // ì§„ë™ í”¼ë“œë°± (ì§€ì›í•˜ëŠ” ê¸°ê¸°ì—ì„œë§Œ)
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }
    
    // pull-to-refresh ì°¨ë‹¨
    if (pullDistance > 0) {
      e.preventDefault();
      return false;
    }
  }
}, { passive: false });

// ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ê²½ê³ 
window.addEventListener('beforeunload', function (e) {
  if (!isSaved) {
    e.preventDefault();
    e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ì •ë§ë¡œ í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    return e.returnValue;
  }
});

// F5 í‚¤ ë°©ì§€
document.addEventListener('keydown', function(e) {
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r') || (e.metaKey && e.key === 'r')) {
    e.preventDefault();
    return false;
  }
});

// ìš°í´ë¦­ ë©”ë‰´ ë¹„í™œì„±í™” (ì„ íƒì‚¬í•­)
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  return false;
});
</script>